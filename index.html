<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ğŸ§Š å†°æ°´ä¸»æ©Ÿ AI å°ˆå®¶ç³»çµ±</title>

    <!-- PWA è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#006266">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å†°æ°´AI">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">

    <!-- ç‰ˆæœ¬è™Ÿç®¡ç†ï¼šæ›´æ–°æ™‚ä¿®æ”¹æ­¤ç‰ˆæœ¬è™Ÿï¼Œç€è¦½å™¨æœƒè‡ªå‹•è¼‰å…¥æ–°ç‰ˆæœ¬ -->
    <meta name="app-version" content="1.2.5">
    <script>
        // è‡ªå‹•ç‰ˆæœ¬è™Ÿï¼šä½¿ç”¨ç•¶å‰æ™‚é–“æˆ³ï¼ˆé–‹ç™¼æ™‚ï¼‰æˆ–å›ºå®šç‰ˆæœ¬è™Ÿï¼ˆä¸Šç·šæ™‚ï¼‰
        const APP_VERSION = '1.2.5';  // ä¸Šç·šæ™‚æ‰‹å‹•æ›´æ–°æ­¤ç‰ˆæœ¬è™Ÿ
        const DEV_MODE = false;       // ä¸Šç·šæ™‚æ”¹ç‚º false
        window.CACHE_BUSTER = DEV_MODE ? Date.now() : APP_VERSION;
    </script>

    <!-- æ¨£å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">



    <style>
        body {
            background: #f8f9fa;
            font-family: "Microsoft JhengHei", sans-serif;
            padding-bottom: 80px;
        }

        .hero {
            background: linear-gradient(135deg, #006266, #009432);
            color: #fff;
        }

        .rule-box {
            background-color: #fff;
            border-left: 8px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .rule-title {
            font-weight: 900;
            font-size: 1.4rem;
            margin-bottom: 10px;
            display: block;
        }

        .rule-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #333;
        }

        .rule-content li {
            margin-bottom: 8px;
        }

        .tag-machine {
            background-color: #009432;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .tag-action {
            color: #c0392b;
            font-weight: bold;
            text-decoration: underline;
        }

        .weather-card {
            background: linear-gradient(to right, #1289A7, #12CBC4);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .weather-val {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.96);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .status-text {
            margin-top: 15px;
            color: #444;
            font-weight: bold;
        }

        #preview-area {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background: #fff;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
        }

        .preview-item img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
        }

        .report-text {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 2px solid #eee;
            border-radius: 8px;
            color: #2d3436;
            line-height: 1.8;
            font-size: 1.1rem;
        }

        /* é æ¸¬å¡ç‰‡æ¨£å¼ */
        .forecast-card {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .forecast-card .chart-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .forecast-card canvas {
            width: 100%;
            height: 150px;
        }

        .forecast-alert {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .forecast-alert.warning {
            background: rgba(255, 193, 7, 0.3);
            border-left: 4px solid #ffc107;
        }

        .forecast-alert.info {
            background: rgba(46, 204, 113, 0.3);
            border-left: 4px solid #2ecc71;
        }

        /* æé†’é€šçŸ¥æ¨£å¼ */
        .reminder-card {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .reminder-card .countdown {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ffeaa7;
        }

        .reminder-card .status-icon {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .reminder-card .status-icon.active {
            background: #00b894;
        }

        .reminder-card .status-icon.inactive {
            background: #d63031;
        }

        @keyframes bell-ring {

            0%,
            100% {
                transform: rotate(0);
            }

            10%,
            30%,
            50% {
                transform: rotate(15deg);
            }

            20%,
            40% {
                transform: rotate(-15deg);
            }
        }

        .bell-animate {
            animation: bell-ring 0.5s ease-in-out;
        }

        /* é€²éšå°è©±è¦–çª—æ¨£å¼ */
        .chat-section {
            margin-top: 20px;
            border: 2px solid #009432;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }

        .chat-header {
            background: linear-gradient(135deg, #006266, #009432);
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #006266, #009432);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble.ai {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.system {
            background: #fff3cd;
            color: #856404;
            margin: 10px auto;
            text-align: center;
            font-size: 0.85rem;
            max-width: 90%;
        }

        .chat-input-area {
            display: flex;
            padding: 12px;
            background: white;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input-area input:focus {
            border-color: #009432;
        }

        .chat-input-area button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #006266, #009432);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-input-area button:hover {
            opacity: 0.9;
        }

        .chat-input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 12px;
            background: #f0f0f0;
            border-top: 1px solid #eee;
        }

        .quick-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #009432;
            color: white;
            border-color: #009432;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #009432;
            border-radius: 50%;
            animation: typing 1s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>

    <section class="hero is-small">
        <div class="hero-body">
            <div class="container">
                <p class="title is-4"><i class="fas fa-industry"></i> å†°æ°´ä¸»æ©Ÿ AI å°ˆå®¶ç³»çµ±</p>
                <p class="subtitle is-6">SOP è¦å‰‡ + AI è¦–è¦ºåˆ¤è®€ (æ‰‹æ©Ÿç‰ˆ)</p>
            </div>
        </div>
    </section>

    <div class="container mt-4">
        <div class="columns">

            <div class="column is-4">

                <div class="weather-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left"><strong><i class="fas fa-cloud-sun"></i> å¤–æ°£ç’°å¢ƒ</strong></div>
                        <div class="level-right"><button class="button is-small is-white is-outlined is-rounded"
                                onclick="initWeather(true)">å¼·åˆ¶åˆ·æ–°</button></div>
                    </div>
                    <div class="columns is-mobile has-text-centered is-gapless">
                        <div class="column"><small>æº«åº¦</small>
                            <div id="w-temp" class="weather-val">--</div>
                        </div>
                        <div class="column"><small>æ¿•åº¦</small>
                            <div id="w-hum" class="weather-val">--</div>
                        </div>
                        <div class="column"><small>ç„“å€¼</small>
                            <div id="w-h" class="weather-val" style="color:#ffeaa7;">--</div>
                        </div>
                    </div>
                    <p id="location-status" class="help mt-2"
                        style="color:#ffeaa7; font-size:0.8rem; text-align:center;">æ­£åœ¨åˆå§‹åŒ–...
                    </p>
                </div>

                <!-- å®šæ™‚æé†’å¡ç‰‡ -->
                <div class="reminder-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left">
                            <strong><i class="fas fa-bell" id="bell-icon"></i> å®šæ™‚æé†’</strong>
                        </div>
                        <div class="level-right">
                            <button class="button is-small is-warning is-outlined is-rounded mr-2"
                                onclick="testPreAlert()" title="æ¸¬è©¦é è­¦åŠŸèƒ½">ğŸ”® é è­¦</button>
                            <button class="button is-small is-info is-outlined is-rounded mr-2" onclick="testReminder()"
                                title="æ¸¬è©¦æ­£å¼é€šçŸ¥">â° æ­£å¼</button>
                            <button class="button is-small is-white is-outlined is-rounded"
                                onclick="testNotification()">ğŸ”” æ¸¬è©¦</button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <span class="status-icon" id="notif-status-icon"></span>
                        <span id="notif-status-text">æª¢æŸ¥ä¸­...</span>
                    </div>
                    <div>
                        <small>ä¸‹æ¬¡æé†’ï¼š</small>
                        <span class="countdown" id="next-reminder">è¨ˆç®—ä¸­...</span>
                    </div>
                    <p class="help mt-2" style="opacity:0.8; font-size:0.75rem;">
                        â° æ¯æ—¥ 08:00ã€12:00 åŠ 18:00 æé†’åˆ†æ
                    </p>
                </div>

                <!-- 24å°æ™‚ç„“å€¼é æ¸¬å¡ç‰‡ -->
                <div class="forecast-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left">
                            <strong><i class="fas fa-crystal-ball"></i> ğŸ”® æœªä¾† 24 å°æ™‚é æ¸¬</strong>
                        </div>
                        <div class="level-right">
                            <button class="button is-small is-warning is-outlined is-rounded mr-2"
                                onclick="testForecastAlerts()" title="æ¸¬è©¦é è­¦">
                                ğŸ§ª
                            </button>
                            <button class="button is-small is-white is-outlined is-rounded"
                                onclick="refresh24HourForecast()">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="enthalpy-chart"></canvas>
                    </div>
                    <div id="forecast-alerts"></div>
                    <p id="forecast-status" class="help mt-2"
                        style="opacity:0.8; font-size:0.75rem; text-align:center;">
                        æ­£åœ¨è¼‰å…¥é å ±è³‡æ–™...
                    </p>
                </div>

                <div class="card">
                    <header class="card-header">
                        <p class="card-header-title">ğŸ“· AI è¦–è¦ºåˆ†æ</p>
                    </header>
                    <div class="card-content">
                        <input class="input" type="file" id="inputImages" accept="image/*" />
                        <div id="preview-area"><span class="has-text-grey">é è¦½å€</span></div>

                        <button id="analyze-button" class="button is-success is-fullwidth mt-4">
                            <span class="icon"><i class="fas fa-search"></i></span>
                            <span><strong>å•Ÿå‹• AI åˆ†æ</strong></span>
                        </button>
                        <button id="reset-key-button" class="button is-small is-ghost is-fullwidth mt-2">è¨­å®š API
                            Key</button>
                    </div>
                </div>
            </div>

            <div class="column is-8">

                <h4 class="title is-5 mb-3">1. SOP ç­–ç•¥å»ºè­°</h4>
                <div id="rule-output">
                    <div class="notification is-light">æ­£åœ¨åˆå§‹åŒ–...</div>
                </div>

                <hr>

                <div class="card" style="position: relative; min-height: 200px;">
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="button is-loading is-large is-white" style="border:none; background:transparent;">
                        </div>
                        <div id="loading-text" class="status-text">AI åˆ†æä¸­...</div>
                    </div>

                    <div class="card-content">
                        <h4 class="title is-5 mb-3">2. AI è¦–è¦ºé©—è­‰å ±å‘Š</h4>
                        <div id="analysis-report" class="content report-text">
                            <p class="has-text-grey-light">ä¸Šå‚³åœ–ç‰‡å¾Œé»æ“Šåˆ†æã€‚AI å°‡åˆ¤è®€ç¶ ç‡ˆé‹è½‰ç‹€æ…‹ã€‚</p>
                        </div>
                    </div>
                </div>

                <!-- é€²éš AI å°è©±å€å¡Š -->
                <div id="chat-section" class="chat-section" style="display: none;">
                    <div class="chat-header">
                        <span><i class="fas fa-comments"></i> 3. é€²éš AI å°è©±</span>
                        <button class="button is-small is-white is-outlined" onclick="clearChat()">
                            <i class="fas fa-trash"></i> æ¸…é™¤å°è©±
                        </button>
                    </div>
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="quick-questions" id="quick-questions">
                        <button class="quick-btn" onclick="askQuickQuestion('ç‚ºä»€éº¼å»ºè­°é€™æ¨£çš„é‹è½‰é…ç½®ï¼Ÿ')">ğŸ’¡ ç‚ºä»€éº¼é€™æ¨£é…ç½®ï¼Ÿ</button>
                        <button class="quick-btn" onclick="askQuickQuestion('ç›®å‰é‹è½‰æ˜¯å¦ç¬¦åˆç¯€èƒ½åŸå‰‡ï¼Ÿ')">ğŸŒ± æ˜¯å¦ç¯€èƒ½ï¼Ÿ</button>
                        <button class="quick-btn" onclick="askQuickQuestion('æœ‰ä»€éº¼éœ€è¦æ³¨æ„çš„åœ°æ–¹å—ï¼Ÿ')">âš ï¸ æ³¨æ„äº‹é …ï¼Ÿ</button>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                            onkeypress="handleChatKeypress(event)">
                        <button id="chat-send" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i>
                            ç™¼é€</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // å…¨åŸŸè®Šæ•¸
        // ==========================================
        // â˜… æ‰‹æ©Ÿç‰ˆä¿®æ­£ï¼šé è¨­å€¼ç›´æ¥å¡«å…¥ï¼Œé¿å… undefined éŒ¯èª¤
        let globalWeather = { temp: 26.5, hum: 60, enthalpy: 50 };
        let userApiKey = localStorage.getItem("openrouter_key") || "";
        let globalBase64 = null;

        // ==========================================
        // å®šæ™‚æé†’åŠŸèƒ½
        // ==========================================
        // æ­£å¼æé†’æ™‚é–“
        const REMINDER_TIMES = [
            { hour: 8, minute: 0, label: 'æ—©ä¸Š', type: 'reminder' },
            { hour: 12, minute: 0, label: 'ä¸­åˆ', type: 'reminder' },
            { hour: 18, minute: 0, label: 'ä¸‹åˆ', type: 'reminder' }
        ];
        // æå‰é è­¦åˆ†ææ™‚é–“ï¼ˆæå‰ 1 å°æ™‚ï¼‰
        const PRE_ALERT_TIMES = [
            { hour: 7, minute: 0, label: 'æ—©ä¸Šé è­¦', targetHour: 8 },
            { hour: 11, minute: 0, label: 'ä¸­åˆé è­¦', targetHour: 12 },
            { hour: 17, minute: 0, label: 'ä¸‹åˆé è­¦', targetHour: 18 }
        ];
        let notificationPermission = 'default';
        let lastNotifiedTime = localStorage.getItem('lastNotifiedTime') || '';

        // è«‹æ±‚é€šçŸ¥æ¬Šé™
        async function requestNotificationPermission() {
            const statusIcon = document.getElementById('notif-status-icon');
            const statusText = document.getElementById('notif-status-text');

            if (!('Notification' in window)) {
                statusIcon.className = 'status-icon inactive';
                statusText.textContent = 'ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥';
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationPermission = 'granted';
                statusIcon.className = 'status-icon active';
                statusText.textContent = 'é€šçŸ¥å·²å•Ÿç”¨ âœ“';
                return true;
            }

            if (Notification.permission === 'denied') {
                notificationPermission = 'denied';
                statusIcon.className = 'status-icon inactive';
                statusText.textContent = 'é€šçŸ¥è¢«æ‹’çµ•ï¼Œè«‹åˆ°è¨­å®šé–‹å•Ÿ';
                return false;
            }

            // è«‹æ±‚æ¬Šé™
            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                if (permission === 'granted') {
                    statusIcon.className = 'status-icon active';
                    statusText.textContent = 'é€šçŸ¥å·²å•Ÿç”¨ âœ“';
                    return true;
                } else {
                    statusIcon.className = 'status-icon inactive';
                    statusText.textContent = 'è«‹å…è¨±é€šçŸ¥ä»¥æ¥æ”¶æé†’';
                    return false;
                }
            } catch (e) {
                statusIcon.className = 'status-icon inactive';
                statusText.textContent = 'ç„¡æ³•è«‹æ±‚é€šçŸ¥æ¬Šé™';
                return false;
            }
        }

        // è¨ˆç®—ä¸‹æ¬¡æé†’æ™‚é–“
        function getNextReminderTime() {
            const now = new Date();
            let nextReminder = null;

            for (const time of REMINDER_TIMES) {
                const reminderDate = new Date();
                reminderDate.setHours(time.hour, time.minute, 0, 0);

                if (reminderDate > now) {
                    if (!nextReminder || reminderDate < nextReminder) {
                        nextReminder = reminderDate;
                    }
                }
            }

            // å¦‚æœä»Šå¤©çš„æé†’éƒ½éäº†ï¼Œè¨ˆç®—æ˜å¤©çš„ç¬¬ä¸€å€‹æé†’
            if (!nextReminder) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const firstTime = REMINDER_TIMES.reduce((a, b) =>
                    (a.hour * 60 + a.minute) < (b.hour * 60 + b.minute) ? a : b
                );
                tomorrow.setHours(firstTime.hour, firstTime.minute, 0, 0);
                nextReminder = tomorrow;
            }

            return nextReminder;
        }

        // æ ¼å¼åŒ–å€’æ•¸è¨ˆæ™‚
        function formatCountdown(ms) {
            if (ms <= 0) return 'ç¾åœ¨ï¼';

            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);

            if (hours > 0) {
                return `${hours}æ™‚${minutes}åˆ†`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${seconds}ç§’`;
            } else {
                return `${seconds}ç§’`;
            }
        }

        // ==========================================
        // éŸ³æ•ˆç³»çµ±
        // ==========================================
        let audioContext = null;

        // åˆå§‹åŒ–éŸ³è¨Šä¸Šä¸‹æ–‡
        async function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // å¦‚æœ AudioContext è¢«æš«åœï¼ˆç€è¦½å™¨è‡ªå‹•æ’­æ”¾æ”¿ç­–ï¼‰ï¼Œå˜—è©¦æ¢å¾©
            if (audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                    console.log('ğŸ”Š AudioContext å·²æ¢å¾©');
                } catch (e) {
                    console.warn('ç„¡æ³•æ¢å¾© AudioContext:', e);
                }
            }
            return audioContext;
        }

        // æ’­æ”¾é è­¦éŸ³æ•ˆï¼ˆæ€¥ä¿ƒè­¦å‘ŠéŸ³ï¼‰
        async function playWarningSound() {
            try {
                const ctx = await getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 880;  // é«˜éŸ³ A5
                oscillator.type = 'square';

                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);

                oscillator.start(ctx.currentTime);

                // æ€¥ä¿ƒçš„å—¶å—¶å—¶è²
                for (let i = 0; i < 3; i++) {
                    gainNode.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.2);
                    gainNode.gain.setValueAtTime(0, ctx.currentTime + i * 0.2 + 0.1);
                }

                oscillator.stop(ctx.currentTime + 0.6);
                console.log('ğŸ”Š æ’­æ”¾é è­¦éŸ³æ•ˆ');
            } catch (e) {
                console.warn('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ', e);
            }
        }

        // æ’­æ”¾æ­£å¼é€šçŸ¥éŸ³æ•ˆï¼ˆæº«å’Œéˆ´è²ï¼‰
        async function playReminderSound() {
            try {
                const ctx = await getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 523.25;  // ä¸­éŸ³ C5
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.4, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 1);
                console.log('ğŸ”” æ’­æ”¾æ­£å¼é€šçŸ¥éŸ³æ•ˆ');
            } catch (e) {
                console.warn('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ', e);
            }
        }

        // æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆï¼ˆçŸ­ä¿ƒæç¤ºéŸ³ï¼‰
        async function playTestSound() {
            try {
                const ctx = await getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 659.25;  // E5
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.3);
                console.log('ğŸµ æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆ');
            } catch (e) {
                console.warn('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ', e);
            }
        }

        // ==========================================
        // åˆ†é æ¨™é¡Œé–ƒçˆæé†’åŠŸèƒ½
        // ==========================================
        let titleFlashInterval = null;
        const originalTitle = document.title;

        // é–‹å§‹é–ƒçˆæ¨™é¡Œï¼ˆæœƒåœ¨å·¥ä½œåˆ—çš„åˆ†é ä¸Šé¡¯ç¤ºï¼‰
        function startTitleFlash(alertText) {
            // å¦‚æœå·²ç¶“åœ¨é–ƒçˆï¼Œå…ˆåœæ­¢
            stopTitleFlash();

            let isOriginal = true;
            titleFlashInterval = setInterval(() => {
                document.title = isOriginal ? alertText : originalTitle;
                isOriginal = !isOriginal;
            }, 500);  // æ¯ 0.5 ç§’åˆ‡æ›ä¸€æ¬¡

            console.log('ğŸ”” é–‹å§‹åˆ†é æ¨™é¡Œé–ƒçˆæé†’');
        }

        // åœæ­¢é–ƒçˆæ¨™é¡Œ
        function stopTitleFlash() {
            if (titleFlashInterval) {
                clearInterval(titleFlashInterval);
                titleFlashInterval = null;
                document.title = originalTitle;
                console.log('ğŸ”” åœæ­¢åˆ†é æ¨™é¡Œé–ƒçˆæé†’');
            }
        }

        // ç•¶é é¢ç²å¾—ç„¦é»æ™‚åœæ­¢é–ƒçˆ
        window.addEventListener('focus', stopTitleFlash);

        // ç™¼é€é€šçŸ¥ï¼ˆæ”¯æ´ä¸åŒé¡å‹çš„éŸ³æ•ˆï¼‰
        // soundType: 'warning' | 'reminder' | 'test' | 'none'
        function sendNotification(title, body, soundType = 'reminder') {
            // é–‹å§‹åˆ†é æ¨™é¡Œé–ƒçˆæé†’
            const flashText = soundType === 'warning' ? 'ğŸ”® é è­¦é€šçŸ¥ï¼' : 'â° åˆ†ææé†’ï¼';
            startTitleFlash(flashText);

            // æ’­æ”¾å°æ‡‰éŸ³æ•ˆ
            switch (soundType) {
                case 'warning':
                    playWarningSound();
                    break;
                case 'reminder':
                    playReminderSound();
                    break;
                case 'test':
                    playTestSound();
                    break;
                // 'none' æˆ–å…¶ä»–ï¼šä¸æ’­æ”¾éŸ³æ•ˆ
            }

            // é é¢å…§æé†’
            const bellIcon = document.getElementById('bell-icon');
            bellIcon.classList.add('bell-animate');
            setTimeout(() => bellIcon.classList.remove('bell-animate'), 500);

            // ç€è¦½å™¨é€šçŸ¥ï¼ˆæœƒè®“å·¥ä½œåˆ—é–ƒçˆï¼‰
            if (notificationPermission === 'granted') {
                try {
                    // ä½¿ç”¨å”¯ä¸€ tag + renotify ç¢ºä¿æ¯æ¬¡é€šçŸ¥éƒ½æœƒè®“å·¥ä½œåˆ—é–ƒçˆ
                    const uniqueTag = `chiller-${soundType}-${Date.now()}`;
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'icon-192.png',  // ä½¿ç”¨ PWA åœ–ç¤º
                        tag: uniqueTag,
                        renotify: true,  // ç¢ºä¿å·¥ä½œåˆ—é–ƒçˆ
                        requireInteraction: true,  // å¿…é ˆæ‰‹å‹•é»æ“Šæ‰èƒ½é—œé–‰
                        silent: true  // ä½¿ç”¨æˆ‘å€‘è‡ªå·±çš„éŸ³æ•ˆï¼Œä¸ç”¨ç³»çµ±éŸ³æ•ˆ
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    // ç§»é™¤è‡ªå‹•é—œé–‰ï¼Œå¿…é ˆæ‰‹å‹•ç¢ºèª
                    // setTimeout(() => notification.close(), 30000);
                } catch (e) {
                    console.warn('ç„¡æ³•ç™¼é€é€šçŸ¥', e);
                }
            }

            // é é¢å…§å½ˆçª—ï¼ˆç„¡è«–é é¢ç‹€æ…‹éƒ½é¡¯ç¤ºï¼Œç¢ºä¿å¿…é ˆæ‰‹å‹•ç¢ºèªï¼‰
            setTimeout(() => {
                const confirmed = confirm(`â° ${title}\n\n${body}\n\né»æ“Šã€Œç¢ºå®šã€é—œé–‰æ­¤æé†’`);
                if (confirmed) {
                    console.log('ç”¨æˆ¶å·²ç¢ºèªæé†’');
                }
            }, 100);
        }

        // æª¢æŸ¥æ˜¯å¦è©²æé†’
        function checkReminder() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            // æª¢æŸ¥æå‰é è­¦åˆ†ææ™‚é–“ (07:00, 17:00)
            for (const preAlert of PRE_ALERT_TIMES) {
                if (currentHour === preAlert.hour && currentMinute >= 0 && currentMinute <= 5) {
                    const alertKey = `pre-alert-${now.toDateString()}-${preAlert.hour}`;

                    if (localStorage.getItem(alertKey) !== 'sent') {
                        localStorage.setItem(alertKey, 'sent');

                        // è§¸ç™¼é å ±åˆ†æä¸¦ç™¼é€é€šçŸ¥
                        triggerPreAlertAnalysis(preAlert);
                    }
                }
            }

            // æª¢æŸ¥æ­£å¼æé†’æ™‚é–“ (08:00, 12:00, 18:00)
            for (const time of REMINDER_TIMES) {
                // åœ¨æ•´é»å¾Œ 0-5 åˆ†é˜å…§è§¸ç™¼ï¼ˆèˆ‡é è­¦ä¸€è‡´ï¼‰
                if (currentHour === time.hour && currentMinute >= 0 && currentMinute <= 5) {
                    const reminderKey = `reminder-${now.toDateString()}-${time.hour}`;

                    if (localStorage.getItem(reminderKey) !== 'sent') {
                        localStorage.setItem(reminderKey, 'sent');

                        sendNotification(
                            'ğŸ§Š å†°æ°´ä¸»æ©Ÿåˆ†ææé†’',
                            `${time.label}å¥½ï¼ç¾åœ¨æ˜¯ ${time.hour}:00ï¼Œè«‹é€²è¡Œå†°æ°´ä¸»æ©Ÿé‹è½‰ç‹€æ…‹åˆ†æã€‚`,
                            'reminder'  // æ­£å¼é€šçŸ¥éŸ³æ•ˆ
                        );
                    }
                }
            }
        }

        // æå‰é è­¦åˆ†æ
        async function triggerPreAlertAnalysis(preAlert) {
            console.log(`âš ï¸ è§¸ç™¼æå‰é è­¦åˆ†æ: ${preAlert.label}`);

            try {
                // åˆ·æ–°é å ±è³‡æ–™
                await get24HourForecast();

                // ä½¿ç”¨ globalWeather ä½œç‚ºç›®å‰ç„“å€¼ï¼ˆèˆ‡é é¢é¡¯ç¤ºä¸€è‡´ï¼‰
                const currentEnthalpy = globalWeather.enthalpy;
                const currentRule = getRule(currentEnthalpy);

                // å–å¾—æœªä¾†é æ¸¬ï¼ˆ1 å°æ™‚å¾Œï¼‰
                const futureData = forecastData[1];

                if (futureData) {
                    const futureRule = getRule(futureData.enthalpy);

                    let alertMessage = `ğŸ”® ${preAlert.label}åˆ†æ\n\n`;
                    alertMessage += `ç›®å‰ç„“å€¼: ${currentEnthalpy} kJ/kg (è¦å‰‡ ${currentRule})\n`;
                    alertMessage += `é è¨ˆ ${preAlert.targetHour}:00 ç„“å€¼: ${futureData.enthalpy.toFixed(1)} kJ/kg (è¦å‰‡ ${futureRule})\n\n`;

                    if (currentRule !== futureRule) {
                        alertMessage += `âš ï¸ æ³¨æ„ï¼é‹è½‰ç­–ç•¥å°‡éœ€èª¿æ•´`;
                    } else {
                        alertMessage += `âœ… é‹è½‰ç­–ç•¥ç„¡éœ€è®Šæ›´`;
                    }

                    sendNotification(`ğŸ”® ${preAlert.label} - æå‰é è­¦åˆ†æ`, alertMessage, 'warning');
                } else {
                    // å³ä½¿æ²’æœ‰é å ±è³‡æ–™ä¹Ÿè¦ç™¼é€é€šçŸ¥
                    let alertMessage = `ğŸ”® ${preAlert.label}åˆ†æ\n\n`;
                    alertMessage += `ç›®å‰ç„“å€¼: ${currentEnthalpy} kJ/kg (è¦å‰‡ ${currentRule})\n\n`;
                    alertMessage += `å³å°‡åˆ° ${preAlert.targetHour}:00 åˆ†ææ™‚é–“ï¼Œè«‹æº–å‚™é€²è¡Œå†°æ°´ä¸»æ©Ÿæª¢æŸ¥ã€‚`;
                    sendNotification(`ğŸ”® ${preAlert.label}`, alertMessage, 'warning');
                }
            } catch (e) {
                console.error('é è­¦åˆ†æå¤±æ•—:', e);
                // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦ç™¼é€åŸºæœ¬é€šçŸ¥ï¼ˆä½¿ç”¨ globalWeatherï¼‰
                const currentEnthalpy = globalWeather.enthalpy;
                const currentRule = getRule(currentEnthalpy);
                let alertMessage = `ğŸ”® ${preAlert.label}åˆ†æ\n\n`;
                alertMessage += `ç›®å‰ç„“å€¼: ${currentEnthalpy} kJ/kg (è¦å‰‡ ${currentRule})\n\n`;
                alertMessage += `å³å°‡åˆ° ${preAlert.targetHour}:00 åˆ†ææ™‚é–“ï¼Œè«‹æº–å‚™é€²è¡Œå†°æ°´ä¸»æ©Ÿæª¢æŸ¥ã€‚`;
                sendNotification(`ğŸ”® ${preAlert.label}`, alertMessage, 'warning');
            }
        }

        // æ›´æ–°å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
        function updateCountdown() {
            const nextReminder = getNextReminderTime();
            const now = new Date();
            const diff = nextReminder - now;

            const countdownEl = document.getElementById('next-reminder');
            const timeStr = nextReminder.getHours() < 12 ? 'æ—©ä¸Š' : 'ä¸‹åˆ';
            const hourStr = nextReminder.getHours().toString().padStart(2, '0');
            const minStr = nextReminder.getMinutes().toString().padStart(2, '0');

            countdownEl.textContent = `${timeStr} ${hourStr}:${minStr} (${formatCountdown(diff)})`;
        }

        // æ¸¬è©¦é€šçŸ¥åŠŸèƒ½
        function testNotification() {
            if (notificationPermission !== 'granted') {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        testSWNotification();
                    } else {
                        alert('è«‹å…ˆå…è¨±é€šçŸ¥æ¬Šé™ï¼');
                    }
                });
            } else {
                testSWNotification();
            }
        }

        // æ¸¬è©¦é€šçŸ¥åŠŸèƒ½
        function testSWNotification() {
            // ç›´æ¥ç™¼é€é€šçŸ¥ï¼ˆä¸ä¾è³´ Service Worker controllerï¼‰
            sendNotification('ğŸ§Š æ¸¬è©¦é€šçŸ¥', 'é€šçŸ¥åŠŸèƒ½é‹ä½œæ­£å¸¸ï¼æ‚¨æœƒåœ¨ 08:00ã€12:00 åŠ 18:00 æ”¶åˆ°æé†’ã€‚', 'test');  // æ¸¬è©¦éŸ³æ•ˆ
        }

        // æ¸¬è©¦æ­£å¼é€šçŸ¥åŠŸèƒ½
        function testReminder() {
            console.log('â° æ‰‹å‹•è§¸ç™¼æ­£å¼é€šçŸ¥æ¸¬è©¦');
            const now = new Date();
            const hour = now.getHours();
            const label = hour < 12 ? 'æ—©ä¸Š' : (hour < 17 ? 'ä¸­åˆ' : 'ä¸‹åˆ');

            sendNotification(
                'ğŸ§Š å†°æ°´ä¸»æ©Ÿåˆ†ææé†’',
                `${label}å¥½ï¼ç¾åœ¨æ˜¯ ${hour}:00ï¼Œè«‹é€²è¡Œå†°æ°´ä¸»æ©Ÿé‹è½‰ç‹€æ…‹åˆ†æã€‚`,
                'reminder'  // æ­£å¼é€šçŸ¥éŸ³æ•ˆï¼ˆæº«å’Œéˆ´è²ï¼‰
            );
        }

        // æ¸¬è©¦é è­¦åŠŸèƒ½ï¼ˆæ‰‹å‹•è§¸ç™¼ï¼‰
        function testPreAlert() {
            console.log('ğŸ”® æ‰‹å‹•è§¸ç™¼é è­¦æ¸¬è©¦');

            // æ¨¡æ“¬ä¸€å€‹é è­¦
            const testAlert = {
                hour: new Date().getHours(),
                minute: 0,
                label: 'é è­¦æ¸¬è©¦',
                targetHour: new Date().getHours() + 1
            };

            // è§¸ç™¼é è­¦åˆ†æï¼ˆæœƒé¡¯ç¤ºçœŸå¯¦çš„ç„“å€¼æ•¸æ“šï¼‰
            triggerPreAlertAnalysis(testAlert);
        }

        // åˆå§‹åŒ–æé†’ç³»çµ±
        function initReminderSystem() {
            requestNotificationPermission();
            updateCountdown();

            // æ¯ç§’æ›´æ–°å€’æ•¸è¨ˆæ™‚
            setInterval(updateCountdown, 1000);

            // æ¯ 30 ç§’æª¢æŸ¥æ˜¯å¦è©²æé†’
            setInterval(checkReminder, 30000);

            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
            checkReminder();

            // ===== æ¯ 30 åˆ†é˜è‡ªå‹•åˆ·æ–° 24 å°æ™‚é æ¸¬ =====
            setInterval(() => {
                console.log('ğŸ”„ è‡ªå‹•åˆ·æ–° 24 å°æ™‚é æ¸¬...');
                get24HourForecast();
            }, 30 * 60 * 1000);  // 30 åˆ†é˜ = 30 * 60 * 1000 æ¯«ç§’
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initReminderSystem);

        // è§£é–éŸ³è¨Šï¼ˆç”¨æˆ¶é¦–æ¬¡èˆ‡é é¢äº’å‹•æ™‚ï¼‰
        let audioUnlocked = false;
        async function unlockAudio() {
            if (audioUnlocked) return;
            try {
                const ctx = await getAudioContext();
                // æ’­æ”¾ä¸€å€‹ç„¡è²çš„éŸ³è¨Šä¾†è§£é–
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                gainNode.gain.value = 0;  // ç„¡è²
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                oscillator.start(0);
                oscillator.stop(0.001);
                audioUnlocked = true;
                console.log('ğŸ”“ éŸ³è¨Šå·²è§£é–');
            } catch (e) {
                console.warn('ç„¡æ³•è§£é–éŸ³è¨Š:', e);
            }
        }

        // åœ¨ç”¨æˆ¶é¦–æ¬¡é»æ“Šä»»æ„ä½ç½®æ™‚è§£é–éŸ³è¨Š
        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('touchstart', unlockAudio, { once: true });

        // ==========================================
        // 5. 24 å°æ™‚ç„“å€¼é æ¸¬åŠŸèƒ½
        // ==========================================
        let forecastData = [];
        let forecastChartCtx = null;

        // å–å¾— 24 å°æ™‚å¤©æ°£é å ±
        async function get24HourForecast() {
            try {
                const statusEl = document.getElementById('forecast-status');
                statusEl.textContent = 'æ­£åœ¨å–å¾—å¤©æ°£é å ±...';

                // å°åŒ—å¸‚å—æ¸¯å€åº§æ¨™
                const lat = 25.0554;
                const lon = 121.6169;

                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m&forecast_days=2&timezone=Asia%2FTaipei`);

                if (!res.ok) throw new Error('API å›æ‡‰éŒ¯èª¤');

                const data = await res.json();
                const hourlyTime = data.hourly?.time || [];
                const hourlyTemp = data.hourly?.temperature_2m || [];
                const hourlyHum = data.hourly?.relative_humidity_2m || [];

                // å–å¾—å¾ç¾åœ¨é–‹å§‹çš„ 24 å°æ™‚æ•¸æ“š
                const now = new Date();
                const currentHour = now.getHours();

                forecastData = [];
                for (let i = 0; i < 24; i++) {
                    const dataIndex = currentHour + i;
                    if (dataIndex < hourlyTemp.length) {
                        const temp = hourlyTemp[dataIndex];
                        const hum = hourlyHum[dataIndex];
                        const enthalpy = calculateEnthalpy(temp, hum);
                        const timeStr = hourlyTime[dataIndex];
                        const hour = new Date(timeStr).getHours();

                        forecastData.push({
                            hour: hour,
                            hoursFromNow: i,
                            temp: temp,
                            hum: hum,
                            enthalpy: enthalpy,
                            timeStr: timeStr
                        });
                    }
                }

                statusEl.textContent = `âœ“ æ›´æ–°æ–¼ ${now.toLocaleTimeString('zh-TW')}`;

                // ç¹ªè£½åœ–è¡¨
                drawEnthalpyChart();

                // ç”Ÿæˆé è­¦
                generateForecastAlerts();

                // å„²å­˜åˆ†ææ­·å²
                saveAnalysisHistory();

                return forecastData;

            } catch (e) {
                console.error('é å ±å–å¾—å¤±æ•—:', e);
                document.getElementById('forecast-status').textContent = 'âŒ é å ±å–å¾—å¤±æ•—';
                return [];
            }
        }

        // ç¹ªè£½ç„“å€¼é æ¸¬åœ–è¡¨
        function drawEnthalpyChart() {
            const canvas = document.getElementById('enthalpy-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;

            // è¨­å®šé«˜è§£æåº¦
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;

            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, width, height);

            if (forecastData.length === 0) return;

            // è¨ˆç®—ç¯„åœ
            const enthalpies = forecastData.map(d => d.enthalpy);
            const minH = Math.floor(Math.min(...enthalpies) / 10) * 10 - 10;
            const maxH = Math.ceil(Math.max(...enthalpies) / 10) * 10 + 10;

            // ç¹ªè£½åƒæ•¸
            const padding = { left: 35, right: 10, top: 15, bottom: 25 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // ç¹ªè£½èƒŒæ™¯å€åŸŸ (è¦å‰‡å€é–“)
            const ruleZones = [
                { min: 0, max: 56, color: 'rgba(46, 204, 113, 0.2)', label: 'è¦å‰‡1' },
                { min: 56, max: 72, color: 'rgba(41, 128, 185, 0.2)', label: 'è¦å‰‡2' },
                { min: 72, max: 85, color: 'rgba(230, 126, 34, 0.2)', label: 'è¦å‰‡3' },
                { min: 85, max: 95, color: 'rgba(192, 57, 43, 0.2)', label: 'è¦å‰‡4' },
                { min: 95, max: 150, color: 'rgba(142, 68, 173, 0.2)', label: 'æ¥µé™' }
            ];

            ruleZones.forEach(zone => {
                if (zone.max > minH && zone.min < maxH) {
                    const y1 = padding.top + chartHeight - ((Math.min(zone.max, maxH) - minH) / (maxH - minH)) * chartHeight;
                    const y2 = padding.top + chartHeight - ((Math.max(zone.min, minH) - minH) / (maxH - minH)) * chartHeight;
                    ctx.fillStyle = zone.color;
                    ctx.fillRect(padding.left, y1, chartWidth, y2 - y1);
                }
            });

            // ç¹ªè£½è¦å‰‡è‡¨ç•Œç·š
            const criticalLines = [56, 72, 85, 95];
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 1;

            criticalLines.forEach(h => {
                if (h >= minH && h <= maxH) {
                    const y = padding.top + chartHeight - ((h - minH) / (maxH - minH)) * chartHeight;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();

                    // æ¨™è¨»æ•¸å€¼
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(h.toString(), padding.left - 3, y + 3);
                }
            });

            ctx.setLineDash([]);

            // ç¹ªè£½ç„“å€¼æ›²ç·š
            ctx.beginPath();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;

            forecastData.forEach((d, i) => {
                const x = padding.left + (i / (forecastData.length - 1)) * chartWidth;
                const y = padding.top + chartHeight - ((d.enthalpy - minH) / (maxH - minH)) * chartHeight;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // ç¹ªè£½æ•¸æ“šé»
            forecastData.forEach((d, i) => {
                const x = padding.left + (i / (forecastData.length - 1)) * chartWidth;
                const y = padding.top + chartHeight - ((d.enthalpy - minH) / (maxH - minH)) * chartHeight;

                // é¸æ“‡é¡è‰²
                let pointColor = '#fff';
                if (d.enthalpy >= 95) pointColor = '#9b59b6';
                else if (d.enthalpy >= 85) pointColor = '#e74c3c';
                else if (d.enthalpy >= 72) pointColor = '#f39c12';
                else if (d.enthalpy >= 56) pointColor = '#3498db';
                else pointColor = '#2ecc71';

                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = pointColor;
                ctx.fill();
            });

            // ç¹ªè£½ X è»¸æ¨™ç±¤ (æ¯ 4 å°æ™‚ï¼Œå¾ç¬¬ 4 å°æ™‚é–‹å§‹é¿å…èˆ‡ã€Œç¾åœ¨ã€é‡ç–Š)
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';

            for (let i = 4; i < forecastData.length; i += 4) {  // å¾ i=4 é–‹å§‹ï¼Œé¿å…èˆ‡ã€Œç¾åœ¨ã€é‡ç–Š
                const d = forecastData[i];
                const x = padding.left + (i / (forecastData.length - 1)) * chartWidth;
                ctx.fillText(`${d.hour.toString().padStart(2, '0')}:00`, x, height - 5);
            }

            // æ¨™è¨»ã€Œç¾åœ¨ã€ï¼ˆåªé¡¯ç¤ºã€Œç¾åœ¨ã€ï¼Œä¸é¡¯ç¤ºæ™‚é–“ï¼‰
            ctx.fillStyle = '#ffeaa7';
            ctx.font = 'bold 10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('ç¾åœ¨', padding.left, height - 5);

            // ç¹ªè£½ Y è»¸æ•¸å­—åˆ»åº¦å’Œæ©«å‘æ ¼ç·š
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'right';

            // è¨ˆç®—åˆ»åº¦é–“è·ï¼ˆæ¯ 10 æˆ– 20 ç‚ºä¸€å€‹åˆ»åº¦ï¼‰
            const range = maxH - minH;
            const step = range > 60 ? 20 : 10;

            for (let h = Math.ceil(minH / step) * step; h <= maxH; h += step) {
                const y = padding.top + chartHeight - ((h - minH) / (maxH - minH)) * chartHeight;

                // ç¹ªè£½æ©«å‘æ ¼ç·š
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);  // è™›ç·šæ¨£å¼
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                ctx.setLineDash([]);  // é‡ç½®ç‚ºå¯¦ç·š

                // ç¹ªè£½æ•¸å­—æ¨™ç±¤
                ctx.fillText(h.toString(), padding.left - 5, y + 3);
            }
        }

        // ç”Ÿæˆé è­¦æç¤º
        function generateForecastAlerts() {
            const alertsContainer = document.getElementById('forecast-alerts');
            if (!alertsContainer || forecastData.length === 0) return;

            const alerts = [];
            const currentEnthalpy = forecastData[0]?.enthalpy || 0;
            const currentRule = getRule(currentEnthalpy);

            // ===== 1. è¶¨å‹¢åˆ†æé è­¦ (æœªä¾† 6 å°æ™‚) =====
            let foundRuleChange = false;
            for (let i = 1; i <= 6 && i < forecastData.length; i++) {
                const d = forecastData[i];
                const prevEnthalpy = forecastData[i - 1]?.enthalpy || currentEnthalpy;
                const prevRule = getRule(prevEnthalpy);
                const nextRule = getRule(d.enthalpy);

                // è¦å‰‡è®ŠåŒ–é è­¦
                if (prevRule !== nextRule && !foundRuleChange) {
                    const timeStr = `${d.hour.toString().padStart(2, '0')}:00`;

                    if (d.enthalpy >= 72 && prevEnthalpy < 72) {
                        alerts.push({
                            type: 'warning',
                            icon: 'âš ï¸',
                            message: `é è¨ˆ ${timeStr} ç„“å€¼å°‡é” ${d.enthalpy.toFixed(0)}ï¼Œå»ºè­° ${getTimeOffset(d.hour, -30)} å‰åˆ‡æ›è‡³å¤§å†°æ©Ÿ`
                        });
                        foundRuleChange = true;
                    } else if (d.enthalpy < 56 && prevEnthalpy >= 56) {
                        alerts.push({
                            type: 'info',
                            icon: 'ğŸ’¡',
                            message: `é è¨ˆ ${timeStr} ç„“å€¼å°‡é™è‡³ ${d.enthalpy.toFixed(0)}ï¼Œå¯é—œé–‰å¤§å†°æ©Ÿç¯€èƒ½`
                        });
                        foundRuleChange = true;
                    } else if (d.enthalpy >= 85 && prevEnthalpy < 85) {
                        alerts.push({
                            type: 'warning',
                            icon: 'ğŸ”¥',
                            message: `é è¨ˆ ${timeStr} é€²å…¥é«˜è² è¼‰å€ (ç„“å€¼ ${d.enthalpy.toFixed(0)})ï¼Œå»ºè­°åŠ é–‹å°å†°æ©Ÿ`
                        });
                        foundRuleChange = true;
                    } else if (d.enthalpy >= 95 && prevEnthalpy < 95) {
                        alerts.push({
                            type: 'warning',
                            icon: 'ï¿½',
                            message: `é è¨ˆ ${timeStr} é€²å…¥æ¥µé™è² è¼‰å€ (ç„“å€¼ ${d.enthalpy.toFixed(0)})ï¼Œå»ºè­°å…¨é–‹å†°æ©Ÿ`
                        });
                        foundRuleChange = true;
                    } else if (d.enthalpy < 72 && prevEnthalpy >= 72) {
                        alerts.push({
                            type: 'info',
                            icon: 'ğŸ“‰',
                            message: `é è¨ˆ ${timeStr} ç„“å€¼å°‡é™è‡³ ${d.enthalpy.toFixed(0)}ï¼Œå¯è€ƒæ…®åˆ‡å›å°å†°æ©Ÿ`
                        });
                        foundRuleChange = true;
                    }
                }
            }

            // ===== 2. é«˜ç„“å€¼æŒçºŒé è­¦ =====
            if (currentEnthalpy >= 85) {
                const highLoadHours = forecastData.filter(d => d.hoursFromNow <= 6 && d.enthalpy >= 85).length;
                if (highLoadHours >= 4) {
                    alerts.push({
                        type: 'warning',
                        icon: 'ğŸŒ¡ï¸',
                        message: `æœªä¾† 6 å°æ™‚å…§æœ‰ ${highLoadHours} å°æ™‚ç¶­æŒé«˜è² è¼‰ (ç„“å€¼ â‰¥85)ï¼Œæ³¨æ„è¨­å‚™è² è·`
                    });
                }
            }

            // ===== 3. å³å°‡å‡æº«é è­¦ (2 å°æ™‚å…§ç„“å€¼æ˜é¡¯ä¸Šå‡) =====
            if (forecastData.length >= 3) {
                const twoHourLater = forecastData[2]?.enthalpy || currentEnthalpy;
                const enthalpyRise = twoHourLater - currentEnthalpy;
                if (enthalpyRise >= 8) {
                    alerts.push({
                        type: 'warning',
                        icon: 'ğŸ“ˆ',
                        message: `æœªä¾† 2 å°æ™‚ç„“å€¼é è¨ˆä¸Šå‡ ${enthalpyRise.toFixed(0)} (${currentEnthalpy.toFixed(0)} â†’ ${twoHourLater.toFixed(0)})ï¼Œå»ºè­°æå‰æº–å‚™`
                    });
                }
            }

            // ===== 4. å³°å€¼é è­¦ =====
            const maxForecast = forecastData.slice(0, 12).reduce((max, d) => d.enthalpy > max.enthalpy ? d : max, forecastData[0]);
            if (maxForecast.hoursFromNow > 0 && maxForecast.enthalpy >= 80 && maxForecast.enthalpy > currentEnthalpy + 5) {
                alerts.push({
                    type: 'info',
                    icon: 'ğŸ¯',
                    message: `é è¨ˆ ${maxForecast.hour.toString().padStart(2, '0')}:00 é”åˆ°ç„“å€¼å³°å€¼ ${maxForecast.enthalpy.toFixed(0)}`
                });
            }

            // å‚æ™šé™æº«æé†’ (17:00-19:00)
            const now = new Date();
            const currentHour = now.getHours();
            if (currentHour >= 15 && currentHour <= 17) {
                const eveningData = forecastData.filter(d => d.hour >= 18 && d.hour <= 20);
                if (eveningData.length > 0) {
                    const avgEvening = eveningData.reduce((a, b) => a + b.enthalpy, 0) / eveningData.length;
                    if (avgEvening < currentEnthalpy - 5) {
                        alerts.push({
                            type: 'info',
                            icon: 'ğŸŒ…',
                            message: `å‚æ™šé™æº«ä¸­ï¼Œé è¨ˆ 18:00 å¾Œç„“å€¼å°‡é™è‡³ ${avgEvening.toFixed(0)}ï¼Œå¯è€ƒæ…®æ¸›è¼‰`
                        });
                    }
                }
            }

            // é¡¯ç¤ºé è­¦
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="forecast-alert info">âœ… æœªä¾† 6 å°æ™‚å…§ç„¡éœ€èª¿æ•´é‹è½‰ç­–ç•¥</div>';
            } else {
                alertsContainer.innerHTML = alerts.map(a =>
                    `<div class="forecast-alert ${a.type}">${a.icon} ${a.message}</div>`
                ).join('');

                // ç™¼é€ç€è¦½å™¨é€šçŸ¥ (æ‰€æœ‰é è­¦éƒ½æœƒå½ˆçª—)
                const warningAlerts = alerts.filter(a => a.type === 'warning');
                const infoAlerts = alerts.filter(a => a.type === 'info');

                // æ¯ 30 åˆ†é˜å¯é€šçŸ¥ä¸€æ¬¡ï¼ˆé…åˆåˆ·æ–°é »ç‡ï¼‰
                const lastForecastNotify = localStorage.getItem('lastForecastNotify') || '';
                const halfHour = Math.floor(now.getMinutes() / 30);
                const currentKey = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}-${now.getHours()}-${halfHour}`;

                if (lastForecastNotify !== currentKey) {
                    localStorage.setItem('lastForecastNotify', currentKey);

                    // è­¦å‘Šé¡å‹é è­¦ï¼ˆæ€¥ä¿ƒéŸ³æ•ˆï¼‰
                    if (warningAlerts.length > 0) {
                        const allWarnings = warningAlerts.map(a => `${a.icon} ${a.message}`).join('\n');
                        sendNotification(
                            'ğŸ”® è¶¨å‹¢åˆ†æé è­¦',
                            allWarnings,
                            'warning'  // æ€¥ä¿ƒè­¦å‘ŠéŸ³
                        );
                    }

                    // æç¤ºé¡å‹é è­¦ï¼ˆæº«å’ŒéŸ³æ•ˆï¼‰- å»¶é² 2 ç§’é¿å…åŒæ™‚å½ˆçª—
                    if (infoAlerts.length > 0) {
                        setTimeout(() => {
                            const allInfos = infoAlerts.map(a => `${a.icon} ${a.message}`).join('\n');
                            sendNotification(
                                'ğŸ’¡ æ™ºèƒ½åˆ†ææé†’',
                                allInfos,
                                'reminder'  // æº«å’Œéˆ´è²
                            );
                        }, warningAlerts.length > 0 ? 2000 : 0);
                    }
                }
            }
        }

        // å–å¾—ç„“å€¼å°æ‡‰çš„è¦å‰‡ç·¨è™Ÿ
        function getRule(enthalpy) {
            if (enthalpy >= 95) return 5;
            if (enthalpy >= 85) return 4;
            if (enthalpy >= 72) return 3;
            if (enthalpy >= 56) return 2;
            return 1;
        }

        // è¨ˆç®—æ™‚é–“åç§»
        function getTimeOffset(hour, minutes) {
            const date = new Date();
            date.setHours(hour);
            date.setMinutes(0);
            date.setMinutes(date.getMinutes() + minutes);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        // å„²å­˜åˆ†ææ­·å²åˆ° localStorage
        function saveAnalysisHistory() {
            if (forecastData.length === 0) return;

            const now = new Date();
            const key = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}`;

            const currentData = forecastData[0];
            const historyEntry = {
                enthalpy: currentData.enthalpy,
                temp: currentData.temp,
                hum: currentData.hum,
                rule: getRule(currentData.enthalpy),
                timestamp: now.toISOString()
            };

            // è®€å–ç¾æœ‰æ­·å²
            let history = {};
            try {
                history = JSON.parse(localStorage.getItem('chillerHistory') || '{}');
            } catch (e) {
                history = {};
            }

            // æ–°å¢ç´€éŒ„
            history[key] = historyEntry;

            // åªä¿ç•™æœ€è¿‘ 7 å¤©çš„æ•¸æ“š
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const cutoffDate = sevenDaysAgo.toISOString().slice(0, 10);

            Object.keys(history).forEach(k => {
                if (k < cutoffDate) {
                    delete history[k];
                }
            });

            localStorage.setItem('chillerHistory', JSON.stringify(history));
        }

        // ===== æ¸¬è©¦é è­¦åŠŸèƒ½ =====
        function testForecastAlerts() {
            const alertsContainer = document.getElementById('forecast-alerts');
            if (!alertsContainer) return alert('æ‰¾ä¸åˆ°é è­¦å®¹å™¨ï¼');

            // æ¨¡æ“¬ä¸åŒé¡å‹çš„é è­¦
            const testAlerts = [
                { type: 'warning', icon: 'âš ï¸', message: 'ã€æ¸¬è©¦ã€‘é è¨ˆ 14:00 ç„“å€¼å°‡é” 75ï¼Œå»ºè­° 13:30 å‰åˆ‡æ›è‡³å¤§å†°æ©Ÿ' },
                { type: 'warning', icon: 'ğŸ”¥', message: 'ã€æ¸¬è©¦ã€‘é è¨ˆ 15:00 é€²å…¥é«˜è² è¼‰å€ (ç„“å€¼ 88)ï¼Œå»ºè­°åŠ é–‹å°å†°æ©Ÿ' },
                { type: 'info', icon: 'ğŸ“ˆ', message: 'ã€æ¸¬è©¦ã€‘æœªä¾† 2 å°æ™‚ç„“å€¼é è¨ˆä¸Šå‡ 10 (70 â†’ 80)ï¼Œå»ºè­°æå‰æº–å‚™' },
                { type: 'info', icon: 'ğŸ¯', message: 'ã€æ¸¬è©¦ã€‘é è¨ˆ 16:00 é”åˆ°ç„“å€¼å³°å€¼ 92' },
                { type: 'info', icon: 'ğŸ’¡', message: 'ã€æ¸¬è©¦ã€‘é è¨ˆ 20:00 ç„“å€¼å°‡é™è‡³ 52ï¼Œå¯é—œé–‰å¤§å†°æ©Ÿç¯€èƒ½' }
            ];

            // é¡¯ç¤ºæ‰€æœ‰æ¸¬è©¦é è­¦
            alertsContainer.innerHTML =
                '<div class="forecast-alert info" style="background: #fff3cd; border-left-color: #f39c12;">ğŸ§ª æ¸¬è©¦æ¨¡å¼ - ä»¥ä¸‹ç‚ºæ¨¡æ“¬é è­¦</div>' +
                testAlerts.map(a =>
                    `<div class="forecast-alert ${a.type}">${a.icon} ${a.message}</div>`
                ).join('');

            // æ›´æ–°ç‹€æ…‹
            document.getElementById('forecast-status').textContent = 'ğŸ§ª æ¸¬è©¦é è­¦å·²è§¸ç™¼ - 5 ç§’å¾Œæ¢å¾©æ­£å¸¸';

            // 5 ç§’å¾Œæ¢å¾©æ­£å¸¸é è­¦
            setTimeout(() => {
                generateForecastAlerts();
                document.getElementById('forecast-status').textContent = 'âœ“ å·²æ¢å¾©æ­£å¸¸é è­¦é¡¯ç¤º';
            }, 5000);

            // ç™¼é€æ¸¬è©¦é€šçŸ¥ï¼ˆå¦‚æœæœ‰æ¬Šé™ï¼‰
            if (notificationPermission === 'granted') {
                sendNotification('ğŸ§ª é è­¦æ¸¬è©¦', 'æ¸¬è©¦é è­¦åŠŸèƒ½é‹ä½œæ­£å¸¸ï¼');
            }

            console.log('âœ… é è­¦æ¸¬è©¦å®Œæˆï¼Œå…±é¡¯ç¤º', testAlerts.length, 'æ¢æ¸¬è©¦é è­¦');
        }

        // åˆ·æ–°é å ±
        function refresh24HourForecast() {
            const btn = event?.target?.closest('button');
            if (btn) {
                btn.classList.add('is-loading');
                setTimeout(() => btn.classList.remove('is-loading'), 1000);
            }
            get24HourForecast();
        }

        // åˆå§‹åŒ–é æ¸¬ç³»çµ±
        function initForecastSystem() {
            get24HourForecast();

            // æ¯ 30 åˆ†é˜æ›´æ–°ä¸€æ¬¡é å ±
            setInterval(get24HourForecast, 30 * 60 * 1000);

            // è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡ç¹ªåœ–è¡¨
            window.addEventListener('resize', () => {
                if (forecastData.length > 0) {
                    drawEnthalpyChart();
                }
            });
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–é æ¸¬ç³»çµ±
        document.addEventListener('DOMContentLoaded', initForecastSystem);


        const MODEL_FALLBACK_LIST = [
            // Google ç³»åˆ—
            "google/gemini-2.0-flash-exp:free",
            "google/gemma-3-4b-it:free",
            // Meta Llama ç³»åˆ—
            "meta-llama/llama-3.3-70b-instruct:free",
            "meta-llama/llama-3.2-11b-vision-instruct:free",
            "meta-llama/llama-3.2-3b-instruct:free",
            // Mistral ç³»åˆ—
            "mistralai/mistral-small-3.1-24b-instruct:free",
            "mistralai/devstral-2512:free",
            // Qwen ç³»åˆ—
            "qwen/qwen-2.5-vl-72b-instruct:free",
            "qwen/qwen-2.5-72b-instruct:free",
            "qwen/qwen-2-7b-instruct:free",
            // å…¶ä»–æ¨¡å‹
            "nvidia/llama-3.1-nemotron-70b-instruct:free",
            "microsoft/phi-3-medium-128k-instruct:free",
            "allenai/olmo-3.1-32b-think:free",
            "xiaomi/mimo-v2-flash:free"
        ];

        // ==========================================
        // 1. ç„“å€¼èˆ‡è¦å‰‡ (Local Logic)
        // ==========================================
        function calculateEnthalpy(temp, rh) {
            if (!temp || !rh) return 0;
            const Es = 6.112 * Math.exp((17.67 * temp) / (temp + 243.5));
            const E = Es * (rh / 100);
            const w = 0.622 * E / (1013.25 - E);
            const h = 1.006 * temp + w * (2501 + 1.86 * temp);
            return parseFloat(h.toFixed(1));
        }

        function runRuleEngine() {
            try {
                const h = globalWeather.enthalpy;

                let color = "#bdc3c7";
                let title = "ç­‰å¾…æ¢ä»¶...";
                let content = "";

                // --- æ ¹æ“šç„“å€¼è‡ªå‹•åˆ¤æ–·è¦å‰‡ ---
                if (h >= 95) {
                    color = "#8e44ad";
                    title = `ã€æ¥µé™è² è¼‰ã€‘ å¤–æ°£ç„“å€¼ ${h} (â‰§ 95)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">1å°å¤§å†°</span> + <span class="tag-machine">2å°å°å†°</span> (å…¨é–‹)ã€‚</li><li>æŒ‡ä»¤ï¼šç¢ºä¿æ•£ç†±æ•ˆç‡æœ€å¤§åŒ–ã€‚</li></ul>`;
                } else if (h >= 85 && h <= 94) {
                    color = "#c0392b";
                    title = `ã€è¦å‰‡ 4ã€‘ å¤–æ°£ç„“å€¼ ${h} (85~94)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">1å°å¤§å†°</span> (100%) + åŠ é–‹ <span class="tag-machine">4è™Ÿå°å†°</span>ã€‚</li><li>æ°´æ³µï¼šå¤§æ³µ48Hzï¼Œå°æ³µ40~42Hzã€‚</li></ul>`;
                } else if (h >= 72 && h <= 84) {
                    color = "#e67e22";
                    title = `ã€è¦å‰‡ 3ã€‘ å¤–æ°£ç„“å€¼ ${h} (72~84)`;
                    content = `<ul><li>æ“ä½œæŒ‡ä»¤ï¼š<span class="tag-action">åˆ‡æ›è‡³ä¸€å°å¤§å†°</span> (1è™Ÿæˆ–2è™Ÿ)ã€‚</li><li>æ°´æ³µï¼šä¸Šé™ 48Hzã€‚</li></ul>`;
                } else if (h >= 56 && h < 72) {
                    color = "#2980b9";
                    title = `ã€è¦å‰‡ 2ã€‘ å¤–æ°£ç„“å€¼ ${h} (56~71)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">4è™Ÿå°å†°</span> + <span class="tag-machine">åŠ é–‹ 5è™Ÿå°å†°</span>ã€‚</li><li>æ°´æ³µï¼šä¸Šé™ 40Hzã€‚</li></ul>`;
                } else if (h < 56) {
                    color = "#27ae60";
                    title = `ã€è¦å‰‡ 1ã€‘ å¤–æ°£ç„“å€¼ ${h} (< 56)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">4è™Ÿå°å†°</span> å–®ç¨é‹è½‰ã€‚</li><li>æ°´æ³µï¼šä¸Šé™ 45Hzã€‚</li></ul>`;
                }

                document.getElementById("rule-output").innerHTML = `
                <div class="rule-box" style="border-left-color: ${color};">
                    <span class="rule-title" style="color:${color}">${title}</span>
                    <div class="rule-content">${content}</div>
                </div>`;

            } catch (e) { console.error("è¦å‰‡é‹ç®—éŒ¯èª¤:", e); }
        }


        // ==========================================
        // 2. å¤©æ°£åˆå§‹åŒ– (æ‰‹æ©Ÿç‰ˆä¿®æ­£ - å®Œæ•´éŒ¯èª¤è™•ç†)
        // ==========================================

        // é¡¯ç¤ºå®šä½ç‹€æ…‹è¨Šæ¯
        function showLocationStatus(message, isError = false) {
            const statusEl = document.getElementById("location-status");
            if (statusEl) {
                statusEl.innerText = message;
                statusEl.style.color = isError ? "#ff6b6b" : "#ffeaa7";
            }
        }

        function setWeatherData(t, rh, source = "å—æ¸¯å€") {
            const h = calculateEnthalpy(t, rh);
            document.getElementById("w-temp").innerText = t;
            document.getElementById("w-hum").innerText = rh;
            document.getElementById("w-h").innerText = h;
            globalWeather = { temp: t, hum: rh, enthalpy: h };
            showLocationStatus(`âœ“ ${source}`);
            runRuleEngine();
        }

        // å–å¾—å°åŒ—å¸‚å—æ¸¯å€å¤©æ°£
        async function getNangangWeather() {
            try {
                showLocationStatus("æ­£åœ¨å–å¾—å—æ¸¯å€å¤©æ°£...");
                // å°åŒ—å¸‚å—æ¸¯å€åº§æ¨™
                const lat = 25.0554;
                const lon = 121.6169;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relative_humidity_2m`);
                if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");
                const data = await res.json();
                const t = data.current_weather?.temperature;
                const rh = data.hourly?.relative_humidity_2m?.[new Date().getHours()];
                if (t !== undefined && rh !== undefined) {
                    setWeatherData(t, rh, "å—æ¸¯å€å³æ™‚å¤©æ°£");
                    return true;
                }
            } catch (e) {
                console.warn("å¤©æ°£ API å¤±æ•—", e);
            }
            return false;
        }

        // ä½¿ç”¨æœ¬åœ°é è¨­å€¼ (å®Œå…¨ä¸éœ€è¦ç¶²è·¯)
        function useLocalDefault() {
            // æ ¹æ“šæœˆä»½ä¼°ç®—åˆç†çš„æº«æ¿•åº¦é è¨­å€¼ (å°ç£æ°£å€™)
            const month = new Date().getMonth() + 1;
            let temp, hum;

            if (month >= 6 && month <= 9) {
                // å¤å­£ (6-9æœˆ)
                temp = 30 + Math.random() * 4; // 30-34Â°C
                hum = 70 + Math.random() * 15;  // 70-85%
            } else if (month >= 12 || month <= 2) {
                // å†¬å­£ (12-2æœˆ)
                temp = 15 + Math.random() * 5; // 15-20Â°C
                hum = 65 + Math.random() * 15;  // 65-80%
            } else {
                // æ˜¥ç§‹å­£
                temp = 22 + Math.random() * 6; // 22-28Â°C
                hum = 65 + Math.random() * 15;  // 65-80%
            }

            temp = parseFloat(temp.toFixed(1));
            hum = Math.round(hum);

            setWeatherData(temp, hum, `å—æ¸¯å€ä¼°ç®—å€¼ (${month}æœˆ)`);
        }

        // åˆå§‹åŒ–å¤©æ°£ï¼ˆå›ºå®šä½¿ç”¨å—æ¸¯å€ï¼‰
        async function initWeather() {
            showLocationStatus("æ­£åœ¨å–å¾—å—æ¸¯å€å¤©æ°£...");

            const success = await getNangangWeather();
            if (!success) {
                showLocationStatus("âš ï¸ ç¶²è·¯å—é™ï¼Œä½¿ç”¨æœ¬åœ°ä¼°ç®—", true);
                useLocalDefault();
            }
        }

        // å•Ÿå‹•
        initWeather();

        // ==========================================
        // 3. AI è¦–è¦ºåˆ†æ
        // ==========================================

        async function callAIModel(modelName, prompt) {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${userApiKey}`, "Content-Type": "application/json", "HTTP-Referer": window.location.href },
                body: JSON.stringify({
                    model: modelName,
                    messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: globalBase64 } }] }]
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            if (!data.choices || !data.choices.length) throw new Error("ç„¡å›æ‡‰");
            return data.choices[0].message.content;
        }

        async function tryAnalysisRecursive(modelIndex, prompt) {
            if (modelIndex >= MODEL_FALLBACK_LIST.length) throw new Error("æ‰€æœ‰ AI æ¨¡å‹ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            const loadingText = document.getElementById("loading-text");
            loadingText.innerText = `AI åˆ†æä¸­ (å˜—è©¦æ¨¡å‹ ${modelIndex + 1})...`;

            try {
                return await callAIModel(MODEL_FALLBACK_LIST[modelIndex], prompt);
            } catch (error) {
                console.warn(`Model failed`, error);
                return await tryAnalysisRecursive(modelIndex + 1, prompt);
            }
        }

        document.getElementById("inputImages").addEventListener("change", (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    document.getElementById("preview-area").innerHTML = `<img src="${evt.target.result}">`;
                    globalBase64 = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById("reset-key-button").addEventListener("click", () => {
            const key = prompt("è¼¸å…¥ OpenRouter API Key:", userApiKey);
            if (key) { userApiKey = key.trim(); localStorage.setItem("openrouter_key", userApiKey); }
        });

        document.getElementById("analyze-button").addEventListener("click", async () => {
            if (!globalBase64) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
            if (!userApiKey) {
                userApiKey = prompt("è«‹è¼¸å…¥ API Key (OpenRouter):");
                if (!userApiKey) return;
                localStorage.setItem("openrouter_key", userApiKey);
            }

            const overlay = document.getElementById("loading-overlay");
            const reportDiv = document.getElementById("analysis-report");
            overlay.style.display = "flex";

            try {
                const prompt = `
            è«‹å¿«é€Ÿåˆ¤è®€é€™å¼µå†°æ°´ä¸»æ©Ÿ SCADA ç•«é¢ã€‚

            ã€ä»»å‹™ã€‘åªéœ€åˆ¤æ–· CHU-G01ã€CHU-G02ã€CHU-G03ã€CHU-G04ã€CHU-G05 é€™äº”å°ä¸»æ©Ÿçš„é‹è½‰ç‹€æ…‹ã€‚
            ã€åˆ¤æ–·æ¨™æº–ã€‘äº®ç¶ ç‡ˆ = é‹è½‰ä¸­ï¼Œéç¶ ç‡ˆ = åœæ­¢ã€‚
            
            ã€ç›®å‰æ¢ä»¶ã€‘ç„“å€¼ ${globalWeather.enthalpy} kJ/kg

            è«‹ç”¨ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š
            âœ… é‹è½‰ä¸­ï¼šCHU-Gxx, CHU-Gxxï¼ˆåˆ—å‡ºäº®ç¶ ç‡ˆçš„ä¸»æ©Ÿï¼‰
            â¸ï¸ åœæ­¢ä¸­ï¼šCHU-Gxxï¼ˆåˆ—å‡ºéç¶ ç‡ˆçš„ä¸»æ©Ÿï¼‰
            ğŸ“Š é‹è½‰å°æ•¸ï¼šX å°
            ğŸ’¡ ç¯€èƒ½å»ºè­°ï¼šæ ¹æ“šç„“å€¼ ${globalWeather.enthalpy}ï¼Œç°¡çŸ­èªªæ˜æ˜¯å¦ç¬¦åˆç¯€èƒ½é‚è¼¯ã€‚
            `;

                const result = await tryAnalysisRecursive(0, prompt);
                reportDiv.innerHTML = result.replace(/\n/g, "<br>");

                // åˆå§‹åŒ–é€²éšå°è©±
                initChatAfterAnalysis(result);

            } catch (err) {
                reportDiv.innerHTML = `<span style="color:red; font-weight:bold;">âŒ åˆ†æå¤±æ•—ï¼š${err.message}</span>`;
            } finally {
                overlay.style.display = "none";
            }
        });

        // ==========================================
        // 4. é€²éš AI å°è©±åŠŸèƒ½
        // ==========================================
        let chatHistory = [];
        let initialAnalysisResult = '';

        function initChatAfterAnalysis(analysisResult) {
            initialAnalysisResult = analysisResult;
            chatHistory = [
                {
                    role: "system",
                    content: `ä½ æ˜¯å†°æ°´ä¸»æ©Ÿå°ˆå®¶ AI åŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯ä½ å‰›æ‰å° SCADA ç•«é¢çš„åˆæ­¥åˆ†æçµæœï¼š
${analysisResult}

ç›®å‰ç’°å¢ƒæ¢ä»¶ï¼šç„“å€¼ ${globalWeather.enthalpy} kJ/kgï¼Œæº«åº¦ ${globalWeather.temp}Â°Cï¼Œæ¿•åº¦ ${globalWeather.hum}%ã€‚

ã€é‡è¦é™åˆ¶ã€‘
1. ä½ åªèƒ½å›ç­”èˆ‡ä»¥ä¸‹ä¸»é¡Œç›¸é—œçš„å•é¡Œï¼š
   - ç•«é¢ä¸Šé¡¯ç¤ºçš„å†°æ°´ä¸»æ©Ÿé‹è½‰ç‹€æ…‹
   - ç¯€èƒ½å»ºè­°èˆ‡åˆ†æçµæœ
   - ç„“å€¼èˆ‡ç’°å¢ƒæ¢ä»¶çš„è§£é‡‹
   - å†°æ°´ä¸»æ©Ÿçš„é‹è½‰æ“ä½œå»ºè­°

2. å¦‚æœä½¿ç”¨è€…è©¢å•èˆ‡ä¸Šè¿°ä¸»é¡Œç„¡é—œçš„å•é¡Œï¼Œè«‹ç¦®è²Œåœ°å›è¦†ï¼š
   ã€ŒæŠ±æ­‰ï¼Œæˆ‘åªèƒ½å›ç­”èˆ‡ç›®å‰å†°æ°´ä¸»æ©Ÿåˆ†æçµæœç›¸é—œçš„å•é¡Œã€‚è«‹é‡å°ç•«é¢ä¸Šçš„åˆ†æçµæœæå•ã€‚ã€

ã€æ¥å—ç³¾æ­£ã€‘
å¦‚æœä½¿ç”¨è€…æŒ‡å‡ºä½ çš„åˆ†æåˆ¤æ–·æœ‰èª¤ï¼ˆä¾‹å¦‚ï¼šä¸»æ©Ÿé‹è½‰ç‹€æ…‹åˆ¤è®€éŒ¯èª¤ã€ç¶ ç‡ˆèª¤åˆ¤ç­‰ï¼‰ï¼Œè«‹ï¼š
1. ç¦®è²Œåœ°æ¥å—ç³¾æ­£ä¸¦æ„Ÿè¬ä½¿ç”¨è€…
2. æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æ­£ç¢ºè³‡è¨Šï¼Œé‡æ–°èª¿æ•´ä½ çš„åˆ†æçµè«–
3. åŸºæ–¼ä¿®æ­£å¾Œçš„ç‹€æ…‹ï¼Œæ›´æ–°ç¯€èƒ½å»ºè­°

ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œå›ç­”ç°¡æ½”æ˜ç­ã€‚`
                }
            ];

            // é¡¯ç¤ºå°è©±å€å¡Š
            const chatSection = document.getElementById('chat-section');
            chatSection.style.display = 'block';

            // æ¸…ç©ºä¸¦æ·»åŠ æ­¡è¿è¨Šæ¯
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '';
            appendMessage('system', 'âœ… åˆæ­¥åˆ†æå®Œæˆï¼æ‚¨å¯ä»¥é‡å°åˆ†æçµæœæå‡ºé€²ä¸€æ­¥çš„å•é¡Œã€‚');

            // æ»¾å‹•åˆ°å°è©±å€å¡Š
            chatSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function appendMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role}`;
            bubble.innerHTML = content.replace(/\n/g, '<br>');
            messagesDiv.appendChild(bubble);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'chat-bubble ai';
            indicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            messagesDiv.appendChild(indicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function sendChatMessage(customMessage = null) {
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send');
            const message = customMessage || input.value.trim();

            if (!message) return;
            if (!userApiKey) {
                alert('è«‹å…ˆè¨­å®š API Keyï¼');
                return;
            }

            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            appendMessage('user', message);
            if (!customMessage) input.value = '';

            // æ·»åŠ åˆ°æ­·å²
            chatHistory.push({ role: 'user', content: message });

            // ç¦ç”¨è¼¸å…¥
            input.disabled = true;
            sendBtn.disabled = true;
            showTypingIndicator();

            try {
                // ä½¿ç”¨å‚™æ´æ¨¡å‹æ©Ÿåˆ¶
                let aiReply = null;
                let lastError = null;

                for (let i = 0; i < MODEL_FALLBACK_LIST.length; i++) {
                    try {
                        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${userApiKey}`,
                                "Content-Type": "application/json",
                                "HTTP-Referer": window.location.href
                            },
                            body: JSON.stringify({
                                model: MODEL_FALLBACK_LIST[i],
                                messages: chatHistory
                            })
                        });

                        const data = await response.json();

                        if (data.error) throw new Error(data.error.message);
                        if (!data.choices || !data.choices.length) throw new Error('ç„¡å›æ‡‰');

                        aiReply = data.choices[0].message.content;
                        break; // æˆåŠŸå°±è·³å‡ºè¿´åœˆ
                    } catch (modelErr) {
                        console.warn(`å°è©±æ¨¡å‹ ${i + 1} å¤±æ•—:`, modelErr.message);
                        lastError = modelErr;
                        // ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                    }
                }

                hideTypingIndicator();

                if (!aiReply) {
                    throw lastError || new Error('æ‰€æœ‰æ¨¡å‹éƒ½ç„¡æ³•å›æ‡‰');
                }

                chatHistory.push({ role: 'assistant', content: aiReply });
                appendMessage('ai', aiReply);

            } catch (err) {
                hideTypingIndicator();
                appendMessage('system', `âŒ éŒ¯èª¤ï¼š${err.message}`);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function askQuickQuestion(question) {
            sendChatMessage(question);
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }

        function clearChat() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                chatHistory = chatHistory.slice(0, 1); // ä¿ç•™ system prompt
                appendMessage('system', 'å°è©±å·²æ¸…é™¤ã€‚æ‚¨å¯ä»¥ç¹¼çºŒæå•ã€‚');
            }
        }

        // ==========================================
        // PWA Service Worker è¨»å†Š (å«èƒŒæ™¯åŒæ­¥)
        // ==========================================
        let swRegistration = null;

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // ä½¿ç”¨ç‰ˆæœ¬è™Ÿç¢ºä¿ Service Worker æ›´æ–°
                    const swUrl = `sw.js?v=${window.CACHE_BUSTER || Date.now()}`;
                    swRegistration = await navigator.serviceWorker.register(swUrl);
                    console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ (ç‰ˆæœ¬:', window.CACHE_BUSTER, ')');

                    // ç­‰å¾… Service Worker å•Ÿç”¨
                    await navigator.serviceWorker.ready;
                    console.log('âœ… Service Worker å·²å•Ÿç”¨');

                    // å˜—è©¦è¨»å†Šå®šæœŸèƒŒæ™¯åŒæ­¥ (Chrome é™å®š)
                    if ('periodicSync' in swRegistration) {
                        try {
                            const status = await navigator.permissions.query({ name: 'periodic-background-sync' });
                            if (status.state === 'granted') {
                                await swRegistration.periodicSync.register('check-chiller-reminder', {
                                    minInterval: 60 * 60 * 1000 // æ¯å°æ™‚æª¢æŸ¥
                                });
                                console.log('âœ… å®šæœŸèƒŒæ™¯åŒæ­¥å·²è¨»å†Š');
                            } else {
                                console.log('âš ï¸ å®šæœŸèƒŒæ™¯åŒæ­¥æ¬Šé™æœªæˆäºˆ');
                            }
                        } catch (e) {
                            console.log('âš ï¸ å®šæœŸèƒŒæ™¯åŒæ­¥ä¸å¯ç”¨:', e.message);
                        }
                    }

                    // è¨»å†Šä¸€æ¬¡æ€§èƒŒæ™¯åŒæ­¥
                    if ('sync' in swRegistration) {
                        try {
                            await swRegistration.sync.register('sync-reminder');
                            console.log('âœ… ä¸€æ¬¡æ€§èƒŒæ™¯åŒæ­¥å·²è¨»å†Š');
                        } catch (e) {
                            console.log('âš ï¸ èƒŒæ™¯åŒæ­¥ä¸å¯ç”¨:', e.message);
                        }
                    }

                } catch (err) {
                    console.log('Service Worker è¨»å†Šå¤±æ•—:', err);
                }
            }
        }

        // é é¢é—œé–‰å‰è§¸ç™¼åŒæ­¥
        window.addEventListener('beforeunload', async () => {
            if (swRegistration && 'sync' in swRegistration) {
                try {
                    await swRegistration.sync.register('sync-reminder');
                } catch (e) {
                    // ç„¡æ³•åŒæ­¥ï¼Œå¿½ç•¥
                }
            }
        });

        // é é¢è¼‰å…¥å¾Œè¨»å†Š
        window.addEventListener('load', registerServiceWorker);
    </script>
</body>

</html>