<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>🧊 冰水主機 AI 專家系統</title>

    <!-- PWA 設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#006266">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="冰水AI">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">

    <!-- 版本號管理：更新時修改此版本號，瀏覽器會自動載入新版本 -->
    <meta name="app-version" content="1.3.0">
    <script>
        // 自動版本號：使用當前時間戳（開發時）或固定版本號（上線時）
        const APP_VERSION = '1.3.0';  // 上線時手動更新此版本號
        const DEV_MODE = false;       // 上線時改為 false
        window.CACHE_BUSTER = DEV_MODE ? Date.now() : APP_VERSION;
    </script>

    <!-- 樣式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 自訂樣式 -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <section class="hero is-small">
        <div class="hero-body">
            <div class="container">
                <p class="title is-4"><i class="fas fa-industry"></i> 冰水主機 AI 專家系統</p>
            </div>
        </div>
    </section>

    <div class="container mt-4">
        <div class="columns">

            <div class="column is-4">

                <div class="weather-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left"><strong><i class="fas fa-cloud-sun"></i> 外氣環境</strong></div>
                        <div class="level-right"><button class="button is-small is-white is-outlined is-rounded"
                                onclick="initWeather(true)">強制刷新</button></div>
                    </div>
                    <div class="columns is-mobile has-text-centered is-gapless">
                        <div class="column"><small>溫度</small>
                            <div id="w-temp" class="weather-val">--</div>
                        </div>
                        <div class="column"><small>濕度</small>
                            <div id="w-hum" class="weather-val">--</div>
                        </div>
                        <div class="column"><small>焓值</small>
                            <div id="w-h" class="weather-val" style="color:#ffeaa7;">--</div>
                        </div>
                    </div>
                    <p id="location-status" class="help mt-2"
                        style="color:#ffeaa7; font-size:0.8rem; text-align:center;">正在初始化...
                    </p>
                </div>

                <!-- 電價資訊卡片 -->
                <div class="pricing-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left"><strong><i class="fas fa-bolt"></i> 電價時段</strong></div>
                        <div class="level-right">
                            <span id="pricing-season" class="tag is-small is-warning">--</span>
                        </div>
                    </div>
                    <div id="pricing-display" class="mb-2">
                        <div class="pricing-current">
                            <div class="pricing-type">載入中...</div>
                        </div>
                    </div>
                    <div class="pricing-preview-label"><small>未來 6 小時電價</small></div>
                    <div id="pricing-preview" class="pricing-preview"></div>
                </div>

                <!-- 定時提醒卡片 -->
                <div class="reminder-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left">
                            <strong><i class="fas fa-bell" id="bell-icon"></i> 定時提醒</strong>
                        </div>
                        <div class="level-right">
                            <button class="button is-small is-warning is-outlined is-rounded mr-2"
                                onclick="testPreAlert()" title="測試預警功能">🔮 預警</button>
                            <button class="button is-small is-info is-outlined is-rounded mr-2" onclick="testReminder()"
                                title="測試正式通知">⏰ 正式</button>
                            <button class="button is-small is-white is-outlined is-rounded"
                                onclick="testNotification()">🔔 測試</button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <span class="status-icon" id="notif-status-icon"></span>
                        <span id="notif-status-text">檢查中...</span>
                    </div>
                    <div>
                        <small>下次提醒：</small>
                        <span class="countdown" id="next-reminder">計算中...</span>
                    </div>
                    <p class="help mt-2" style="opacity:0.8; font-size:0.75rem;">
                        ⏰ 每日 08:00、12:00 及 17:00 提醒分析
                    </p>
                </div>

                <!-- 24小時焓值預測卡片 -->
                <div class="forecast-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left">
                            <strong><i class="fas fa-crystal-ball"></i> 🔮 未來 6 小時預測</strong>
                        </div>
                        <div class="level-right">
                            <button class="button is-small is-warning is-outlined is-rounded mr-2"
                                onclick="testForecastAlerts()" title="測試預警">
                                🧪
                            </button>
                            <button class="button is-small is-white is-outlined is-rounded"
                                onclick="refresh24HourForecast()">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="enthalpy-chart"></canvas>
                    </div>
                    <div id="forecast-alerts"></div>
                    <p id="forecast-error-hint" class="help mt-1"
                        style="opacity:0.7; font-size:0.7rem; text-align:center; color:#ffeaa7;">
                        ⚠️ 預測值誤差範圍約 ±3~5，實際天氣可能與預報有差異
                    </p>
                    <p id="forecast-status" class="help mt-1"
                        style="opacity:0.8; font-size:0.75rem; text-align:center;">
                        正在載入預報資料...
                    </p>
                </div>

                <div class="card">
                    <header class="card-header">
                        <p class="card-header-title">📷 AI 視覺分析</p>
                    </header>
                    <div class="card-content">
                        <input class="input" type="file" id="inputImages" accept="image/*" />
                        <div id="preview-area"><span class="has-text-grey">預覽區</span></div>

                        <button id="analyze-button" class="button is-success is-fullwidth mt-4">
                            <span class="icon"><i class="fas fa-search"></i></span>
                            <span><strong>啟動 AI 分析</strong></span>
                        </button>
                        <button id="reset-key-button" class="button is-small is-ghost is-fullwidth mt-2">設定 API
                            Key</button>
                    </div>
                </div>
            </div>

            <div class="column is-8">

                <h4 class="title is-5 mb-3">1. SOP 策略建議</h4>
                <div id="rule-output">
                    <div class="notification is-light">正在初始化...</div>
                </div>

                <hr>

                <!-- AI 智慧分析區塊 -->
                <div class="box"
                    style="background: linear-gradient(135deg, #00b894, #00cec9); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 class="title is-4 mb-3" style="color: white;">🤖 AI 智慧分析</h4>

                    <!-- 負載噸數輸入 -->
                    <div class="columns is-mobile is-vcentered">
                        <div class="column is-8">
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="number" id="current-load" class="input is-medium" inputmode="decimal"
                                        pattern="[0-9]*" placeholder="輸入目前負載噸數"
                                        style="font-size: 1.2rem; height: 50px;">
                                </div>
                                <div class="control">
                                    <span class="button is-static is-medium" style="height: 50px;">RT</span>
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <button class="button is-warning is-medium is-fullwidth" onclick="runAIChillerAnalysis()"
                                style="height: 50px; font-weight: bold;">
                                📊 分析
                            </button>
                        </div>
                    </div>

                    <!-- 目前運轉中的冰機 -->
                    <div class="chiller-selection"
                        style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-top: 12px;">
                        <p style="color: white; font-weight: bold; margin-bottom: 8px;">🏭 目前運轉中的冰機</p>
                        <div class="columns is-mobile is-multiline" style="margin: 0;">
                            <div class="column is-4" style="padding: 4px;">
                                <label class="checkbox"
                                    style="color: white; display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="chiller-g01"> CHU-G01 (大)
                                </label>
                            </div>
                            <div class="column is-4" style="padding: 4px;">
                                <label class="checkbox"
                                    style="color: white; display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="chiller-g02"> CHU-G02 (大)
                                </label>
                            </div>
                            <div class="column is-4" style="padding: 4px;">
                                <label class="checkbox"
                                    style="color: white; display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="chiller-g03"> CHU-G03 (大)
                                </label>
                            </div>
                            <div class="column is-4" style="padding: 4px;">
                                <label class="checkbox"
                                    style="color: white; display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="chiller-g04"> CHU-G04 (小)
                                </label>
                            </div>
                            <div class="column is-4" style="padding: 4px;">
                                <label class="checkbox"
                                    style="color: white; display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="chiller-g05"> CHU-G05 (小)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 冰水溫度 -->
                    <div class="columns is-mobile" style="margin-top: 12px;">
                        <div class="column is-half" style="padding: 4px;">
                            <label style="color: rgba(255,255,255,0.9); font-size: 0.85rem;">冰水出水溫度</label>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="number" id="supply-temp" class="input is-small" inputmode="decimal"
                                        pattern="[0-9.]*" placeholder="7" step="0.1">
                                </div>
                                <div class="control">
                                    <span class="button is-static is-small">°C</span>
                                </div>
                            </div>
                        </div>
                        <div class="column is-half" style="padding: 4px;">
                            <label style="color: rgba(255,255,255,0.9); font-size: 0.85rem;">冰水回水溫度</label>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="number" id="return-temp" class="input is-small" inputmode="decimal"
                                        pattern="[0-9.]*" placeholder="12" step="0.1">
                                </div>
                                <div class="control">
                                    <span class="button is-static is-small">°C</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p style="color: rgba(255,255,255,0.85); font-size: 0.9rem; margin-top: 8px;">
                        🏢 大冰機 3台×715RT + 小冰機 2台×270RT = 總容量 2,685 RT
                    </p>
                    <div id="ai-chiller-result" class="mt-4" style="font-size: 1.1rem; line-height: 1.8;"></div>
                </div>

                <div class="card" style="position: relative; min-height: 200px;">
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="button is-loading is-large is-white" style="border:none; background:transparent;">
                        </div>
                        <div id="loading-text" class="status-text">AI 分析中...</div>
                    </div>

                    <div class="card-content">
                        <h4 class="title is-5 mb-3">2. AI 視覺驗證報告</h4>
                        <div id="analysis-report" class="content report-text">
                            <p class="has-text-grey-light">上傳圖片後點擊分析。AI 將判讀綠燈運轉狀態。</p>
                        </div>
                    </div>
                </div>

                <!-- 進階 AI 對話區塊 -->
                <div id="chat-section" class="chat-section" style="display: none;">
                    <div class="chat-header">
                        <span><i class="fas fa-comments"></i> 3. 進階 AI 對話</span>
                        <button class="button is-small is-white is-outlined" onclick="clearChat()">
                            <i class="fas fa-trash"></i> 清除對話
                        </button>
                    </div>
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="quick-questions" id="quick-questions">
                        <button class="quick-btn" onclick="askQuickQuestion('為什麼建議這樣的運轉配置？')">💡 為什麼這樣配置？</button>
                        <button class="quick-btn" onclick="askQuickQuestion('目前運轉是否符合節能原則？')">🌱 是否節能？</button>
                        <button class="quick-btn" onclick="askQuickQuestion('有什麼需要注意的地方嗎？')">⚠️ 注意事項？</button>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="輸入您的問題..."
                            onkeypress="handleChatKeypress(event)">
                        <button id="chat-send" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i>
                            發送</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- JavaScript 模組 -->
    <script src="app.js"></script><!-- 核心應用程式：冰機配置、SOP規則、全域變數 -->
    <script src="weather.js"></script><!-- 天氣模組：取得外氣溫濕度、計算焓值、24小時預測 -->
    <script src="electricity-pricing.js"></script><!-- 電價模組：時間電價判斷、電費計算 -->
    <script src="ai-analysis.js"></script><!-- AI分析模組：冰機負載分析、AI深度分析、對話功能 -->
    <script src="notifications.js"></script><!-- 通知模組：定時提醒、預警通知、瀏覽器通知 -->
    <script src="pwa.js"></script><!-- PWA模組：Service Worker、離線支援、安裝提示 -->
</body>

</html>