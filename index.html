<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ğŸ§Š å†°æ°´ä¸»æ©Ÿ AI å°ˆå®¶ç³»çµ±</title>

    <!-- PWA è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#006266">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å†°æ°´AI">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- æ¨£å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


    <style>
        body {
            background: #f8f9fa;
            font-family: "Microsoft JhengHei", sans-serif;
            padding-bottom: 80px;
        }

        .hero {
            background: linear-gradient(135deg, #006266, #009432);
            color: #fff;
        }

        .rule-box {
            background-color: #fff;
            border-left: 8px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .rule-title {
            font-weight: 900;
            font-size: 1.4rem;
            margin-bottom: 10px;
            display: block;
        }

        .rule-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #333;
        }

        .rule-content li {
            margin-bottom: 8px;
        }

        .tag-machine {
            background-color: #009432;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .tag-action {
            color: #c0392b;
            font-weight: bold;
            text-decoration: underline;
        }

        .weather-card {
            background: linear-gradient(to right, #1289A7, #12CBC4);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .weather-val {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.96);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .status-text {
            margin-top: 15px;
            color: #444;
            font-weight: bold;
        }

        #preview-area {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background: #fff;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
        }

        .preview-item img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
        }

        .report-text {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 2px solid #eee;
            border-radius: 8px;
            color: #2d3436;
            line-height: 1.8;
            font-size: 1.1rem;
        }

        /* æé†’é€šçŸ¥æ¨£å¼ */
        .reminder-card {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .reminder-card .countdown {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ffeaa7;
        }

        .reminder-card .status-icon {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .reminder-card .status-icon.active {
            background: #00b894;
        }

        .reminder-card .status-icon.inactive {
            background: #d63031;
        }

        @keyframes bell-ring {

            0%,
            100% {
                transform: rotate(0);
            }

            10%,
            30%,
            50% {
                transform: rotate(15deg);
            }

            20%,
            40% {
                transform: rotate(-15deg);
            }
        }

        .bell-animate {
            animation: bell-ring 0.5s ease-in-out;
        }
    </style>
</head>

<body>

    <section class="hero is-small">
        <div class="hero-body">
            <div class="container">
                <p class="title is-4"><i class="fas fa-industry"></i> å†°æ°´ä¸»æ©Ÿ AI å°ˆå®¶ç³»çµ±</p>
                <p class="subtitle is-6">SOP è¦å‰‡ + AI è¦–è¦ºåˆ¤è®€ (æ‰‹æ©Ÿç‰ˆ)</p>
            </div>
        </div>
    </section>

    <div class="container mt-4">
        <div class="columns">

            <div class="column is-4">

                <div class="weather-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left"><strong><i class="fas fa-cloud-sun"></i> å¤–æ°£ç’°å¢ƒ</strong></div>
                        <div class="level-right"><button class="button is-small is-white is-outlined is-rounded"
                                onclick="initWeather(true)">å¼·åˆ¶åˆ·æ–°</button></div>
                    </div>
                    <div class="columns is-mobile has-text-centered is-gapless">
                        <div class="column"><small>æº«åº¦</small>
                            <div id="w-temp" class="weather-val">--</div>
                        </div>
                        <div class="column"><small>æ¿•åº¦</small>
                            <div id="w-hum" class="weather-val">--</div>
                        </div>
                        <div class="column"><small>ç„“å€¼</small>
                            <div id="w-h" class="weather-val" style="color:#ffeaa7;">--</div>
                        </div>
                    </div>
                    <p id="location-status" class="help mt-2"
                        style="color:#ffeaa7; font-size:0.8rem; text-align:center;">æ­£åœ¨åˆå§‹åŒ–...
                    </p>
                </div>

                <!-- å®šæ™‚æé†’å¡ç‰‡ -->
                <div class="reminder-card">
                    <div class="level is-mobile mb-2">
                        <div class="level-left">
                            <strong><i class="fas fa-bell" id="bell-icon"></i> å®šæ™‚æé†’</strong>
                        </div>
                        <div class="level-right">
                            <button class="button is-small is-white is-outlined is-rounded"
                                onclick="testNotification()">æ¸¬è©¦é€šçŸ¥</button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <span class="status-icon" id="notif-status-icon"></span>
                        <span id="notif-status-text">æª¢æŸ¥ä¸­...</span>
                    </div>
                    <div>
                        <small>ä¸‹æ¬¡æé†’ï¼š</small>
                        <span class="countdown" id="next-reminder">è¨ˆç®—ä¸­...</span>
                    </div>
                    <p class="help mt-2" style="opacity:0.8; font-size:0.75rem;">
                        â° æ¯æ—¥ 08:00 åŠ 18:00 æé†’åˆ†æ
                    </p>
                </div>

                <div class="card">
                    <header class="card-header">
                        <p class="card-header-title">ğŸ“· AI è¦–è¦ºåˆ†æ</p>
                    </header>
                    <div class="card-content">
                        <input class="input" type="file" id="inputImages" accept="image/*" />
                        <div id="preview-area"><span class="has-text-grey">é è¦½å€</span></div>

                        <button id="analyze-button" class="button is-success is-fullwidth mt-4">
                            <span class="icon"><i class="fas fa-search"></i></span>
                            <span><strong>å•Ÿå‹• AI åˆ†æ</strong></span>
                        </button>
                        <button id="reset-key-button" class="button is-small is-ghost is-fullwidth mt-2">è¨­å®š API
                            Key</button>
                    </div>
                </div>
            </div>

            <div class="column is-8">

                <h4 class="title is-5 mb-3">1. SOP ç­–ç•¥å»ºè­°</h4>
                <div id="rule-output">
                    <div class="notification is-light">æ­£åœ¨åˆå§‹åŒ–...</div>
                </div>

                <hr>

                <div class="card" style="position: relative; min-height: 200px;">
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="button is-loading is-large is-white" style="border:none; background:transparent;">
                        </div>
                        <div id="loading-text" class="status-text">AI åˆ†æä¸­...</div>
                    </div>

                    <div class="card-content">
                        <h4 class="title is-5 mb-3">2. AI è¦–è¦ºé©—è­‰å ±å‘Š</h4>
                        <div id="analysis-report" class="content report-text">
                            <p class="has-text-grey-light">ä¸Šå‚³åœ–ç‰‡å¾Œé»æ“Šåˆ†æã€‚AI å°‡åˆ¤è®€ç¶ ç‡ˆé‹è½‰ç‹€æ…‹ã€‚</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // å…¨åŸŸè®Šæ•¸
        // ==========================================
        // â˜… æ‰‹æ©Ÿç‰ˆä¿®æ­£ï¼šé è¨­å€¼ç›´æ¥å¡«å…¥ï¼Œé¿å… undefined éŒ¯èª¤
        let globalWeather = { temp: 26.5, hum: 60, enthalpy: 50 };
        let userApiKey = localStorage.getItem("openrouter_key") || "";
        let globalBase64 = null;

        // ==========================================
        // å®šæ™‚æé†’åŠŸèƒ½ (08:00 & 18:00)
        // ==========================================
        const REMINDER_TIMES = [
            { hour: 8, minute: 0 },   // æ—©ä¸Š 8 é»
            { hour: 18, minute: 0 }   // ä¸‹åˆ 6 é»
        ];
        let notificationPermission = 'default';
        let lastNotifiedTime = localStorage.getItem('lastNotifiedTime') || '';

        // è«‹æ±‚é€šçŸ¥æ¬Šé™
        async function requestNotificationPermission() {
            const statusIcon = document.getElementById('notif-status-icon');
            const statusText = document.getElementById('notif-status-text');

            if (!('Notification' in window)) {
                statusIcon.className = 'status-icon inactive';
                statusText.textContent = 'ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥';
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationPermission = 'granted';
                statusIcon.className = 'status-icon active';
                statusText.textContent = 'é€šçŸ¥å·²å•Ÿç”¨ âœ“';
                return true;
            }

            if (Notification.permission === 'denied') {
                notificationPermission = 'denied';
                statusIcon.className = 'status-icon inactive';
                statusText.textContent = 'é€šçŸ¥è¢«æ‹’çµ•ï¼Œè«‹åˆ°è¨­å®šé–‹å•Ÿ';
                return false;
            }

            // è«‹æ±‚æ¬Šé™
            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                if (permission === 'granted') {
                    statusIcon.className = 'status-icon active';
                    statusText.textContent = 'é€šçŸ¥å·²å•Ÿç”¨ âœ“';
                    return true;
                } else {
                    statusIcon.className = 'status-icon inactive';
                    statusText.textContent = 'è«‹å…è¨±é€šçŸ¥ä»¥æ¥æ”¶æé†’';
                    return false;
                }
            } catch (e) {
                statusIcon.className = 'status-icon inactive';
                statusText.textContent = 'ç„¡æ³•è«‹æ±‚é€šçŸ¥æ¬Šé™';
                return false;
            }
        }

        // è¨ˆç®—ä¸‹æ¬¡æé†’æ™‚é–“
        function getNextReminderTime() {
            const now = new Date();
            let nextReminder = null;

            for (const time of REMINDER_TIMES) {
                const reminderDate = new Date();
                reminderDate.setHours(time.hour, time.minute, 0, 0);

                if (reminderDate > now) {
                    if (!nextReminder || reminderDate < nextReminder) {
                        nextReminder = reminderDate;
                    }
                }
            }

            // å¦‚æœä»Šå¤©çš„æé†’éƒ½éäº†ï¼Œè¨ˆç®—æ˜å¤©çš„ç¬¬ä¸€å€‹æé†’
            if (!nextReminder) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const firstTime = REMINDER_TIMES.reduce((a, b) =>
                    (a.hour * 60 + a.minute) < (b.hour * 60 + b.minute) ? a : b
                );
                tomorrow.setHours(firstTime.hour, firstTime.minute, 0, 0);
                nextReminder = tomorrow;
            }

            return nextReminder;
        }

        // æ ¼å¼åŒ–å€’æ•¸è¨ˆæ™‚
        function formatCountdown(ms) {
            if (ms <= 0) return 'ç¾åœ¨ï¼';

            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);

            if (hours > 0) {
                return `${hours}æ™‚${minutes}åˆ†`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${seconds}ç§’`;
            } else {
                return `${seconds}ç§’`;
            }
        }

        // ç™¼é€é€šçŸ¥
        function sendNotification(title, body) {
            // é é¢å…§æé†’
            const bellIcon = document.getElementById('bell-icon');
            bellIcon.classList.add('bell-animate');
            setTimeout(() => bellIcon.classList.remove('bell-animate'), 500);

            // ç€è¦½å™¨é€šçŸ¥
            if (notificationPermission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'ğŸ§Š',
                        tag: 'chiller-reminder',
                        requireInteraction: true
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    // è‡ªå‹•é—œé–‰
                    setTimeout(() => notification.close(), 30000);
                } catch (e) {
                    console.warn('ç„¡æ³•ç™¼é€é€šçŸ¥', e);
                }
            }

            // é é¢å…§å½ˆçª—
            if (document.hidden) {
                // é é¢åœ¨èƒŒæ™¯ï¼Œé€šçŸ¥æœƒé¡¯ç¤º
            } else {
                // é é¢åœ¨å‰æ™¯ï¼Œç”¨ alert
                setTimeout(() => {
                    alert(`â° ${title}\n\n${body}`);
                }, 100);
            }
        }

        // æª¢æŸ¥æ˜¯å¦è©²æé†’
        function checkReminder() {
            const now = new Date();
            const currentTime = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}-${now.getHours()}-${now.getMinutes()}`;

            for (const time of REMINDER_TIMES) {
                if (now.getHours() === time.hour && now.getMinutes() === time.minute) {
                    const reminderKey = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}-${time.hour}-${time.minute}`;

                    // é¿å…é‡è¤‡æé†’
                    if (lastNotifiedTime !== reminderKey) {
                        lastNotifiedTime = reminderKey;
                        localStorage.setItem('lastNotifiedTime', reminderKey);

                        const timeStr = time.hour < 12 ? 'æ—©ä¸Š' : 'ä¸‹åˆ';
                        sendNotification(
                            'ğŸ§Š å†°æ°´ä¸»æ©Ÿåˆ†ææé†’',
                            `${timeStr}å¥½ï¼ç¾åœ¨æ˜¯ ${time.hour}:00ï¼Œè«‹é€²è¡Œå†°æ°´ä¸»æ©Ÿé‹è½‰ç‹€æ…‹åˆ†æã€‚`
                        );
                    }
                }
            }
        }

        // æ›´æ–°å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
        function updateCountdown() {
            const nextReminder = getNextReminderTime();
            const now = new Date();
            const diff = nextReminder - now;

            const countdownEl = document.getElementById('next-reminder');
            const timeStr = nextReminder.getHours() < 12 ? 'æ—©ä¸Š' : 'ä¸‹åˆ';
            const hourStr = nextReminder.getHours().toString().padStart(2, '0');
            const minStr = nextReminder.getMinutes().toString().padStart(2, '0');

            countdownEl.textContent = `${timeStr} ${hourStr}:${minStr} (${formatCountdown(diff)})`;
        }

        // æ¸¬è©¦é€šçŸ¥åŠŸèƒ½
        function testNotification() {
            if (notificationPermission !== 'granted') {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        sendNotification('ğŸ§Š æ¸¬è©¦é€šçŸ¥', 'é€šçŸ¥åŠŸèƒ½é‹ä½œæ­£å¸¸ï¼æ‚¨æœƒåœ¨ 08:00 å’Œ 18:00 æ”¶åˆ°æé†’ã€‚');
                    } else {
                        alert('è«‹å…ˆå…è¨±é€šçŸ¥æ¬Šé™ï¼');
                    }
                });
            } else {
                sendNotification('ğŸ§Š æ¸¬è©¦é€šçŸ¥', 'é€šçŸ¥åŠŸèƒ½é‹ä½œæ­£å¸¸ï¼æ‚¨æœƒåœ¨ 08:00 å’Œ 18:00 æ”¶åˆ°æé†’ã€‚');
            }
        }

        // åˆå§‹åŒ–æé†’ç³»çµ±
        function initReminderSystem() {
            requestNotificationPermission();
            updateCountdown();

            // æ¯ç§’æ›´æ–°å€’æ•¸è¨ˆæ™‚
            setInterval(updateCountdown, 1000);

            // æ¯ 30 ç§’æª¢æŸ¥æ˜¯å¦è©²æé†’
            setInterval(checkReminder, 30000);

            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
            checkReminder();
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initReminderSystem);


        const MODEL_FALLBACK_LIST = [
            // Google ç³»åˆ—
            "google/gemini-2.0-flash-exp:free",
            "google/gemma-3-4b-it:free",
            // Meta Llama ç³»åˆ—
            "meta-llama/llama-3.3-70b-instruct:free",
            "meta-llama/llama-3.2-11b-vision-instruct:free",
            "meta-llama/llama-3.2-3b-instruct:free",
            // Mistral ç³»åˆ—
            "mistralai/mistral-small-3.1-24b-instruct:free",
            "mistralai/devstral-2512:free",
            // Qwen ç³»åˆ—
            "qwen/qwen-2.5-vl-72b-instruct:free",
            "qwen/qwen-2.5-72b-instruct:free",
            "qwen/qwen-2-7b-instruct:free",
            // å…¶ä»–æ¨¡å‹
            "nvidia/llama-3.1-nemotron-70b-instruct:free",
            "microsoft/phi-3-medium-128k-instruct:free",
            "allenai/olmo-3.1-32b-think:free",
            "xiaomi/mimo-v2-flash:free"
        ];

        // ==========================================
        // 1. ç„“å€¼èˆ‡è¦å‰‡ (Local Logic)
        // ==========================================
        function calculateEnthalpy(temp, rh) {
            if (!temp || !rh) return 0;
            const Es = 6.112 * Math.exp((17.67 * temp) / (temp + 243.5));
            const E = Es * (rh / 100);
            const w = 0.622 * E / (1013.25 - E);
            const h = 1.006 * temp + w * (2501 + 1.86 * temp);
            return parseFloat(h.toFixed(1));
        }

        function runRuleEngine() {
            try {
                const h = globalWeather.enthalpy;

                let color = "#bdc3c7";
                let title = "ç­‰å¾…æ¢ä»¶...";
                let content = "";

                // --- æ ¹æ“šç„“å€¼è‡ªå‹•åˆ¤æ–·è¦å‰‡ ---
                if (h >= 95) {
                    color = "#8e44ad";
                    title = `ã€æ¥µé™è² è¼‰ã€‘ å¤–æ°£ç„“å€¼ ${h} (â‰§ 95)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">1å°å¤§å†°</span> + <span class="tag-machine">2å°å°å†°</span> (å…¨é–‹)ã€‚</li><li>æŒ‡ä»¤ï¼šç¢ºä¿æ•£ç†±æ•ˆç‡æœ€å¤§åŒ–ã€‚</li></ul>`;
                } else if (h >= 85 && h <= 94) {
                    color = "#c0392b";
                    title = `ã€è¦å‰‡ 4ã€‘ å¤–æ°£ç„“å€¼ ${h} (85~94)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">1å°å¤§å†°</span> (100%) + åŠ é–‹ <span class="tag-machine">4è™Ÿå°å†°</span>ã€‚</li><li>æ°´æ³µï¼šå¤§æ³µ48Hzï¼Œå°æ³µ40~42Hzã€‚</li></ul>`;
                } else if (h >= 72 && h <= 84) {
                    color = "#e67e22";
                    title = `ã€è¦å‰‡ 3ã€‘ å¤–æ°£ç„“å€¼ ${h} (72~84)`;
                    content = `<ul><li>æ“ä½œæŒ‡ä»¤ï¼š<span class="tag-action">åˆ‡æ›è‡³ä¸€å°å¤§å†°</span> (1è™Ÿæˆ–2è™Ÿ)ã€‚</li><li>æ°´æ³µï¼šä¸Šé™ 48Hzã€‚</li></ul>`;
                } else if (h >= 56 && h < 72) {
                    color = "#2980b9";
                    title = `ã€è¦å‰‡ 2ã€‘ å¤–æ°£ç„“å€¼ ${h} (56~71)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">4è™Ÿå°å†°</span> + <span class="tag-machine">åŠ é–‹ 5è™Ÿå°å†°</span>ã€‚</li><li>æ°´æ³µï¼šä¸Šé™ 40Hzã€‚</li></ul>`;
                } else if (h < 56) {
                    color = "#27ae60";
                    title = `ã€è¦å‰‡ 1ã€‘ å¤–æ°£ç„“å€¼ ${h} (< 56)`;
                    content = `<ul><li>é‹è½‰å»ºè­°ï¼š<span class="tag-machine">4è™Ÿå°å†°</span> å–®ç¨é‹è½‰ã€‚</li><li>æ°´æ³µï¼šä¸Šé™ 45Hzã€‚</li></ul>`;
                }

                document.getElementById("rule-output").innerHTML = `
                <div class="rule-box" style="border-left-color: ${color};">
                    <span class="rule-title" style="color:${color}">${title}</span>
                    <div class="rule-content">${content}</div>
                </div>`;

            } catch (e) { console.error("è¦å‰‡é‹ç®—éŒ¯èª¤:", e); }
        }


        // ==========================================
        // 2. å¤©æ°£åˆå§‹åŒ– (æ‰‹æ©Ÿç‰ˆä¿®æ­£ - å®Œæ•´éŒ¯èª¤è™•ç†)
        // ==========================================

        // é¡¯ç¤ºå®šä½ç‹€æ…‹è¨Šæ¯
        function showLocationStatus(message, isError = false) {
            const statusEl = document.getElementById("location-status");
            if (statusEl) {
                statusEl.innerText = message;
                statusEl.style.color = isError ? "#ff6b6b" : "#ffeaa7";
            }
        }

        function setWeatherData(t, rh, source = "å®šä½") {
            const h = calculateEnthalpy(t, rh);
            document.getElementById("w-temp").innerText = t;
            document.getElementById("w-hum").innerText = rh;
            document.getElementById("w-h").innerText = h;
            globalWeather = { temp: t, hum: rh, enthalpy: h };
            showLocationStatus(`âœ“ ${source}`);
            runRuleEngine();
        }

        // ä½¿ç”¨å›ºå®šåº§æ¨™ (å°åŒ—) å–å¾—å³æ™‚å¤©æ°£
        async function getWeatherByDefaultLocation() {
            try {
                showLocationStatus("æ­£åœ¨å–å¾—å°åŒ—å¤©æ°£...");
                // å°åŒ—å¸‚åº§æ¨™
                const lat = 25.033;
                const lon = 121.565;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relative_humidity_2m`);
                if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");
                const data = await res.json();
                const t = data.current_weather?.temperature;
                const rh = data.hourly?.relative_humidity_2m?.[new Date().getHours()];
                if (t !== undefined && rh !== undefined) {
                    setWeatherData(t, rh, "å°åŒ—å³æ™‚å¤©æ°£");
                    return true;
                }
            } catch (e) {
                console.warn("å¤©æ°£ API å¤±æ•—", e);
            }
            return false;
        }

        // ä½¿ç”¨æœ¬åœ°é è¨­å€¼ (å®Œå…¨ä¸éœ€è¦ç¶²è·¯)
        function useLocalDefault() {
            // æ ¹æ“šæœˆä»½ä¼°ç®—åˆç†çš„æº«æ¿•åº¦é è¨­å€¼ (å°ç£æ°£å€™)
            const month = new Date().getMonth() + 1;
            let temp, hum;

            if (month >= 6 && month <= 9) {
                // å¤å­£ (6-9æœˆ)
                temp = 30 + Math.random() * 4; // 30-34Â°C
                hum = 70 + Math.random() * 15;  // 70-85%
            } else if (month >= 12 || month <= 2) {
                // å†¬å­£ (12-2æœˆ)
                temp = 15 + Math.random() * 5; // 15-20Â°C
                hum = 65 + Math.random() * 15;  // 65-80%
            } else {
                // æ˜¥ç§‹å­£
                temp = 22 + Math.random() * 6; // 22-28Â°C
                hum = 65 + Math.random() * 15;  // 65-80%
            }

            temp = parseFloat(temp.toFixed(1));
            hum = Math.round(hum);

            setWeatherData(temp, hum, `å­£ç¯€ä¼°ç®—å€¼ (${month}æœˆ)`);
        }

        async function initWeather(force = false) {
            showLocationStatus("æ­£åœ¨å–å¾—ç’°å¢ƒæ•¸æ“š...");

            // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šfile:// å”è­°ä¸‹ï¼ŒCORS æœƒé˜»æ“‹å¹¾ä¹æ‰€æœ‰å¤–éƒ¨è«‹æ±‚
            //     ç›´æ¥å˜—è©¦å¤©æ°£ APIï¼Œå¦‚æœå¤±æ•—å°±ç”¨æœ¬åœ°é è¨­å€¼
            const isFileProtocol = location.protocol === 'file:';

            if (isFileProtocol) {
                showLocationStatus("æœ¬æ©Ÿæª”æ¡ˆæ¨¡å¼...");
                // å…ˆå˜—è©¦å‘¼å«å¤©æ°£ APIï¼ˆæœ‰äº›ç€è¦½å™¨å…è¨±ï¼‰
                const success = await getWeatherByDefaultLocation();
                if (!success) {
                    // å¦‚æœ API ä¹Ÿå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è¨ˆç®—çš„é è¨­å€¼
                    showLocationStatus("âš ï¸ ç¶²è·¯å—é™ï¼Œä½¿ç”¨æœ¬åœ°ä¼°ç®—", true);
                    useLocalDefault();
                }
                return;
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºå®‰å…¨ç’°å¢ƒ (HTTPS)
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (!isSecure) {
                showLocationStatus("âš ï¸ é HTTPS ç’°å¢ƒ", true);
                const success = await getWeatherByDefaultLocation();
                if (!success) {
                    useLocalDefault();
                }
                return;
            }

            // æª¢æŸ¥ Geolocation æ”¯æ´
            if (!navigator.geolocation) {
                showLocationStatus("âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´å®šä½", true);
                const success = await getWeatherByDefaultLocation();
                if (!success) {
                    useLocalDefault();
                }
                return;
            }

            // å…ˆæª¢æŸ¥æ¬Šé™ç‹€æ…‹ (å¦‚æœæ”¯æ´ Permissions API)
            if (navigator.permissions) {
                try {
                    const permStatus = await navigator.permissions.query({ name: 'geolocation' });
                    if (permStatus.state === 'denied') {
                        showLocationStatus("âš ï¸ å®šä½æ¬Šé™è¢«æ‹’çµ•", true);
                        const success = await getWeatherByDefaultLocation();
                        if (!success) {
                            useLocalDefault();
                        }
                        return;
                    }
                } catch (e) {
                    // æŸäº›ç€è¦½å™¨ä¸æ”¯æ´ permissions APIï¼Œç¹¼çºŒå˜—è©¦
                }
            }

            // å˜—è©¦ GPS å®šä½
            showLocationStatus("æ­£åœ¨è«‹æ±‚ GPS å®šä½...");
            const options = {
                timeout: 10000,
                maximumAge: 300000,
                enableHighAccuracy: false
            };

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    try {
                        showLocationStatus("GPS å®šä½æˆåŠŸï¼Œå–å¾—å¤©æ°£...");
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true&hourly=relative_humidity_2m`);
                        const data = await res.json();
                        const t = data.current_weather?.temperature;
                        const rh = data.hourly?.relative_humidity_2m?.[new Date().getHours()];
                        if (t !== undefined && rh !== undefined) {
                            setWeatherData(t, rh, "GPS å®šä½");
                        } else {
                            throw new Error("è³‡æ–™ä¸å®Œæ•´");
                        }
                    } catch (e) {
                        console.error("å¤©æ°£ API å¤±æ•—", e);
                        const success = await getWeatherByDefaultLocation();
                        if (!success) {
                            useLocalDefault();
                        }
                    }
                },
                async (err) => {
                    let errorMsg = "å®šä½å¤±æ•—";
                    switch (err.code) {
                        case err.PERMISSION_DENIED:
                            errorMsg = "âš ï¸ è«‹å…è¨±å®šä½æ¬Šé™";
                            break;
                        case err.POSITION_UNAVAILABLE:
                            errorMsg = "âš ï¸ ç„¡æ³•å–å¾—ä½ç½®";
                            break;
                        case err.TIMEOUT:
                            errorMsg = "âš ï¸ å®šä½é€¾æ™‚";
                            break;
                    }
                    console.warn(errorMsg, err);
                    showLocationStatus(errorMsg, true);
                    const success = await getWeatherByDefaultLocation();
                    if (!success) {
                        useLocalDefault();
                    }
                },
                options
            );
        }

        // å•Ÿå‹•
        initWeather();

        // ==========================================
        // 3. AI è¦–è¦ºåˆ†æ
        // ==========================================

        async function callAIModel(modelName, prompt) {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${userApiKey}`, "Content-Type": "application/json", "HTTP-Referer": window.location.href },
                body: JSON.stringify({
                    model: modelName,
                    messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: globalBase64 } }] }]
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            if (!data.choices || !data.choices.length) throw new Error("ç„¡å›æ‡‰");
            return data.choices[0].message.content;
        }

        async function tryAnalysisRecursive(modelIndex, prompt) {
            if (modelIndex >= MODEL_FALLBACK_LIST.length) throw new Error("æ‰€æœ‰ AI æ¨¡å‹ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            const loadingText = document.getElementById("loading-text");
            loadingText.innerText = `AI åˆ†æä¸­ (å˜—è©¦æ¨¡å‹ ${modelIndex + 1})...`;

            try {
                return await callAIModel(MODEL_FALLBACK_LIST[modelIndex], prompt);
            } catch (error) {
                console.warn(`Model failed`, error);
                return await tryAnalysisRecursive(modelIndex + 1, prompt);
            }
        }

        document.getElementById("inputImages").addEventListener("change", (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    document.getElementById("preview-area").innerHTML = `<img src="${evt.target.result}">`;
                    globalBase64 = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById("reset-key-button").addEventListener("click", () => {
            const key = prompt("è¼¸å…¥ OpenRouter API Key:", userApiKey);
            if (key) { userApiKey = key.trim(); localStorage.setItem("openrouter_key", userApiKey); }
        });

        document.getElementById("analyze-button").addEventListener("click", async () => {
            if (!globalBase64) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
            if (!userApiKey) {
                userApiKey = prompt("è«‹è¼¸å…¥ API Key (OpenRouter):");
                if (!userApiKey) return;
                localStorage.setItem("openrouter_key", userApiKey);
            }

            const overlay = document.getElementById("loading-overlay");
            const reportDiv = document.getElementById("analysis-report");
            overlay.style.display = "flex";

            try {
                const prompt = `
            è«‹å¿«é€Ÿåˆ¤è®€é€™å¼µå†°æ°´ä¸»æ©Ÿ SCADA ç•«é¢ã€‚

            ã€ä»»å‹™ã€‘åªéœ€åˆ¤æ–· CHU-G01ã€CHU-G02ã€CHU-G03ã€CHU-G04ã€CHU-G05 é€™äº”å°ä¸»æ©Ÿçš„é‹è½‰ç‹€æ…‹ã€‚
            ã€åˆ¤æ–·æ¨™æº–ã€‘äº®ç¶ ç‡ˆ = é‹è½‰ä¸­ï¼Œéç¶ ç‡ˆ = åœæ­¢ã€‚
            
            ã€ç›®å‰æ¢ä»¶ã€‘ç„“å€¼ ${globalWeather.enthalpy} kJ/kg

            è«‹ç”¨ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š
            âœ… é‹è½‰ä¸­ï¼šCHU-Gxx, CHU-Gxxï¼ˆåˆ—å‡ºäº®ç¶ ç‡ˆçš„ä¸»æ©Ÿï¼‰
            â¸ï¸ åœæ­¢ä¸­ï¼šCHU-Gxxï¼ˆåˆ—å‡ºéç¶ ç‡ˆçš„ä¸»æ©Ÿï¼‰
            ğŸ“Š é‹è½‰å°æ•¸ï¼šX å°
            ğŸ’¡ ç¯€èƒ½å»ºè­°ï¼šæ ¹æ“šç„“å€¼ ${globalWeather.enthalpy}ï¼Œç°¡çŸ­èªªæ˜æ˜¯å¦ç¬¦åˆç¯€èƒ½é‚è¼¯ã€‚
            `;

                const result = await tryAnalysisRecursive(0, prompt);
                reportDiv.innerHTML = result.replace(/\n/g, "<br>");

            } catch (err) {
                reportDiv.innerHTML = `<span style="color:red; font-weight:bold;">âŒ åˆ†æå¤±æ•—ï¼š${err.message}</span>`;
            } finally {
                overlay.style.display = "none";
            }
        });

        // ==========================================
        // PWA Service Worker è¨»å†Š
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ'))
                    .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
            });
        }
    </script>
</body>

</html>
